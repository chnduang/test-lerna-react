<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React-Fiberæ¶æ„æµ…æ | duangdongçš„react</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="reactç›¸å…³çŸ¥è¯†å½’çº³æ€»ç»“">
    <meta name="keywords" content="react,reactè¿›é˜¶,reactæ€§èƒ½ä¼˜åŒ–,react-hooks,reactæºç ">
    
    <link rel="preload" href="/assets/css/0.styles.a427ee9b.css" as="style"><link rel="preload" href="/assets/js/app.c06c5691.js" as="script"><link rel="preload" href="/assets/js/2.e21ead49.js" as="script"><link rel="preload" href="/assets/js/28.4837174d.js" as="script"><link rel="prefetch" href="/assets/js/10.b9a4c71a.js"><link rel="prefetch" href="/assets/js/11.f55d2255.js"><link rel="prefetch" href="/assets/js/12.fe15bcdc.js"><link rel="prefetch" href="/assets/js/13.87a3c5ce.js"><link rel="prefetch" href="/assets/js/14.ebf89fa4.js"><link rel="prefetch" href="/assets/js/15.cda0a8ba.js"><link rel="prefetch" href="/assets/js/16.f9dc23dc.js"><link rel="prefetch" href="/assets/js/17.84340ca0.js"><link rel="prefetch" href="/assets/js/18.bd273a95.js"><link rel="prefetch" href="/assets/js/19.81155919.js"><link rel="prefetch" href="/assets/js/20.9fd76e46.js"><link rel="prefetch" href="/assets/js/21.ace06104.js"><link rel="prefetch" href="/assets/js/22.90ade980.js"><link rel="prefetch" href="/assets/js/23.0666abd7.js"><link rel="prefetch" href="/assets/js/24.a72c373a.js"><link rel="prefetch" href="/assets/js/25.b969cb94.js"><link rel="prefetch" href="/assets/js/26.de056b27.js"><link rel="prefetch" href="/assets/js/27.c42084cb.js"><link rel="prefetch" href="/assets/js/29.ff25f8d5.js"><link rel="prefetch" href="/assets/js/3.860eacbd.js"><link rel="prefetch" href="/assets/js/30.713760c5.js"><link rel="prefetch" href="/assets/js/31.7c617c61.js"><link rel="prefetch" href="/assets/js/32.d175bcfe.js"><link rel="prefetch" href="/assets/js/33.74590403.js"><link rel="prefetch" href="/assets/js/34.83533364.js"><link rel="prefetch" href="/assets/js/35.074e3e13.js"><link rel="prefetch" href="/assets/js/36.1ccfc83b.js"><link rel="prefetch" href="/assets/js/37.a396d472.js"><link rel="prefetch" href="/assets/js/38.db4bd748.js"><link rel="prefetch" href="/assets/js/39.df82dded.js"><link rel="prefetch" href="/assets/js/4.8f6f0475.js"><link rel="prefetch" href="/assets/js/40.c748e8b5.js"><link rel="prefetch" href="/assets/js/5.8b87f02a.js"><link rel="prefetch" href="/assets/js/6.2f86309f.js"><link rel="prefetch" href="/assets/js/7.f1cc41de.js"><link rel="prefetch" href="/assets/js/8.9c653580.js"><link rel="prefetch" href="/assets/js/9.af331656.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427ee9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdongçš„react</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fiber/" class="nav-link router-link-active">
  Fiber
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  è¿›é˜¶
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fiber/" class="nav-link router-link-active">
  Fiber
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  è¿›é˜¶
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fiber/" aria-current="page" class="sidebar-link">Fiber</a></li><li><a href="/fiber/React-Fiberæ¶æ„æµ…æ.html" class="active sidebar-link">React-Fiberæ¶æ„æµ…æ</a></li><li><a href="/fiber/ReactFiberæ˜¯å¦‚ä½•å®ç°æ›´æ–°è¿‡ç¨‹å¯æ§çš„.html" class="sidebar-link">React Fiber æ˜¯å¦‚ä½•å®ç°æ›´æ–°è¿‡ç¨‹å¯æ§çš„</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>diff</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>dom</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>keys</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/fiber/ä»ä¸­æ–­æœºåˆ¶çœ‹ReactFiberæŠ€æœ¯.html" class="sidebar-link">ä»ä¸­æ–­æœºåˆ¶çœ‹ React Fiber æŠ€æœ¯</a></li><li><a href="/fiber/å…­ä¸ªé—®é¢˜è®©ä½ æ›´æ‡‚ReactFiber.html" class="sidebar-link">å…­ä¸ªé—®é¢˜è®©ä½ æ›´æ‡‚ React Fiber</a></li><li><a href="/fiber/ç†è§£å…¶åŸç†fiber.html" class="sidebar-link">æ‰‹å†™Reactçš„Fiberæ¶æ„ï¼Œæ·±å…¥ç†è§£å…¶åŸç†</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-fiberæ¶æ„æµ…æ"><a href="#react-fiberæ¶æ„æµ…æ" class="header-anchor">#</a> React-Fiberæ¶æ„æµ…æ</h1> <blockquote><p><a href="https://mp.weixin.qq.com/s/UyuJEAPGSm8XKHXvNTdQyw" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/UyuJEAPGSm8XKHXvNTdQyw<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="_1-æµè§ˆå™¨æ¸²æŸ“"><a href="#_1-æµè§ˆå™¨æ¸²æŸ“" class="header-anchor">#</a> 1.æµè§ˆå™¨æ¸²æŸ“</h2> <p>ä¸ºäº†æ›´å¥½çš„ç†è§£ React Fiber, æˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸‹æ¸²æŸ“å™¨è¿›ç¨‹çš„å†…éƒ¨å·¥ä½œåŸç†ã€‚</p> <blockquote><p>å‚è€ƒèµ„æ–™:</p> <ol><li><strong>ä»å†…éƒ¨äº†è§£ç°ä»£æµè§ˆå™¨(3)</strong>[1]</li> <li><strong>æ¸²æŸ“æ ‘æ„å»ºã€å¸ƒå±€åŠç»˜åˆ¶</strong>[2]</li></ol></blockquote> <h3 id="_1-1-æ¸²æŸ“å¸§"><a href="#_1-1-æ¸²æŸ“å¸§" class="header-anchor">#</a> 1.1 æ¸²æŸ“å¸§</h3> <p>å¸§ (frame): åŠ¨ç”»è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€å¹…é™æ­¢çš„ç”»é¢å«åšå¸§ã€‚</p> <p>å¸§ç‡ (frame per second): å³æ¯ç§’é’Ÿæ’­æ”¾çš„é™æ­¢ç”»é¢çš„æ•°é‡ã€‚</p> <p>å¸§æ—¶é•¿ (frame running time): æ¯ä¸€å¹…é™æ­¢çš„ç”»é¢çš„åœç•™æ—¶é—´ã€‚</p> <p>ä¸¢å¸§ (dropped frame): å½“æŸä¸€å¸§æ—¶é•¿é«˜äºå¹³å‡å¸§æ—¶é•¿ã€‚</p> <ul><li>ä¸€èˆ¬æ¥è¯´æµè§ˆå™¨åˆ·æ–°ç‡åœ¨60Hz, æ¸²æŸ“ä¸€å¸§æ—¶é•¿å¿…é¡»æ§åˆ¶åœ¨16.67ms (1s / 60 = 16.67ms)ã€‚</li> <li>å¦‚æœæ¸²æŸ“è¶…è¿‡è¯¥æ—¶é—´, å¯¹ç”¨æˆ·è§†è§‰ä¸Šæ¥è¯´ï¼Œä¼šå‡ºç°å¡é¡¿ç°è±¡ï¼Œå³ä¸¢å¸§ (dropped frame)ã€‚</li></ul> <h3 id="_1-2-å¸§ç”Ÿå‘½å‘¨æœŸ"><a href="#_1-2-å¸§ç”Ÿå‘½å‘¨æœŸ" class="header-anchor">#</a> 1.2 å¸§ç”Ÿå‘½å‘¨æœŸ</h3> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/ndgH50E7pIqnSvBHOnuOIY0B4DttcgibPLCnOYCNw8fkibD2aEm2QKZfwDW9bF6ibM7ZT09FufiaD7nqL9DDQSlTzA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡"></p> <p>å›¾: ç®€å•æè¿°å¸§ç”Ÿå‘½å‘¨æœŸ</p> <div class="language- extra-class"><pre class="language-text"><code>ç®€å•æè¿°ä¸€å¸§çš„ç”Ÿå‘½å‘¨æœŸ:

1. ä¸€å¸§å¼€å§‹ã€‚

2. ä¸»çº¿ç¨‹:

- Event Handlers: UIäº¤äº’è¾“å…¥çš„äº‹ä»¶å›è°ƒ, ä¾‹å¦‚inputã€clickã€wheelç­‰ã€‚

- RAF: æ‰§è¡ŒrequestAnimationFrameå›è°ƒã€‚

- DOM Tree: è§£æHTML, æ„å»ºDOM Tree, å½“JSå¯¹DOMæœ‰å˜æ›´ä¼šé‡æ–°è§¦å‘è¯¥æµç¨‹ã€‚

- CSS Tree: æ„å»ºCSS Treeã€‚è‡³æ­¤æ„å»ºå‡ºRender Treeã€‚

- Layout: æ‰€æœ‰å…ƒç´ çš„positionã€sizeä¿¡æ¯ã€‚

- Paint: åƒç´ å¡«å……, ä¾‹å¦‚é¢œè‰²ã€æ–‡å­—ã€è¾¹æ¡†ç­‰å¯è§†éƒ¨åˆ†ã€‚

- Composite: ç»˜åˆ¶çš„æŒ‡ä»¤ä¿¡æ¯ä¼ åˆ°åˆæˆçº¿ç¨‹ä¸­ã€‚

- RequestIdleCallback: å¦‚æœæ­¤æ—¶ä¸€å¸§è¿˜æœ‰ç©ºä½™æ—¶é—´, åˆ™æ‰§è¡Œè¯¥å›è°ƒã€‚

3. åˆæˆçº¿ç¨‹:

- Raster: åˆæˆçº¿ç¨‹å°†ä¿¡æ¯åˆ†å—, å¹¶æŠŠæ¯å—å‘é€ç»™å…‰æ …çº¿ç¨‹, å…‰æ …çº¿ç¨‹åˆ›å»ºä½å›¾, å¹¶é€šçŸ¥GPUè¿›ç¨‹åˆ·æ–°è¿™ä¸€å¸§ã€‚

4. ä¸€å¸§ç»“æŸã€‚
</code></pre></div><h3 id="_1-3-ä¸¢å¸§å®éªŒ"><a href="#_1-3-ä¸¢å¸§å®éªŒ" class="header-anchor">#</a> 1.3 ä¸¢å¸§å®éªŒ</h3> <p>æ€ä¹ˆå°±ä¸¢å¸§äº†å‘¢?</p> <p>å¯¹äºæµç•…çš„åŠ¨ç”»ï¼Œå¦‚æœä¸€å¸§å¤„ç†æ—¶é—´è¶…è¿‡16msï¼Œå°±èƒ½æ„Ÿåˆ°é¡µé¢çš„å¡é¡¿äº†ã€‚</p> <blockquote><p>Demo: https://linjiayu6.github.io/FE-RequestIdleCallback-demo/</p></blockquote> <blockquote><p>Github: <strong>RequestIdleCallback å®éªŒ</strong>[3]</p></blockquote> <p>å½“ç”¨æˆ·ç‚¹å‡»ä»»ä¸€æŒ‰é”® Aï¼ŒBï¼ŒCï¼Œå› ä¸ºä¸»çº¿ç¨‹æ‰§è¡ŒEvent Handlersä»»åŠ¡ï¼ŒåŠ¨ç”»å› ä¸ºæµè§ˆå™¨ä¸èƒ½åŠæ—¶å¤„ç†ä¸‹ä¸€å¸§ï¼Œå¯¼è‡´åŠ¨ç”»å‡ºç°å¡é¡¿çš„ç°è±¡ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// å¤„ç†åŒæ­¥ä»»åŠ¡ï¼Œå¹¶å ç”¨ä¸»çº¿ç¨‹

const bindClick = id =&gt;

element(id).addEventListener('click', Work.onSyncUnit)

// ç»‘å®šclickäº‹ä»¶

bindClick('btnA')

bindClick('btnB')

bindClick('btnC')

var Work = {

// æœ‰1ä¸‡ä¸ªä»»åŠ¡

unit: 10000,

// å¤„ç†æ¯ä¸ªä»»åŠ¡

onOneUnit: function () { for (var i = 0; i &lt;= 500000; i++) {} },

// åŒæ­¥å¤„ç†: ä¸€æ¬¡å¤„ç†å®Œæ‰€æœ‰ä»»åŠ¡

onSyncUnit: function () {

let _u = 0

while (_u &lt; Work.unit) {

Work.onOneUnit()

_u ++

}

}

}
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h3 id="_1-4-è§£å†³ä¸¢å¸§"><a href="#_1-4-è§£å†³ä¸¢å¸§" class="header-anchor">#</a> 1.4 è§£å†³ä¸¢å¸§</h3> <p>ä¸Šè¿°ï¼Œæˆ‘ä»¬å‘ç° JSè¿ç®—æ˜¯å ç”¨æ¸²æŸ“çš„æ—¶é—´çš„ã€‚</p> <p>åœ¨è¿ç»­åŠ¨ç”»ä¸­ï¼Œè¦åšé«˜è€—æ—¶çš„æ“ä½œï¼Œå¦‚ä½•ä¿è¯å¸§å¹³ç¨³å‘¢ï¼Ÿ</p> <p><strong>è§£å†³ä¸¢å¸§æ€è€ƒå¦‚ä¸‹</strong>:</p> <ol><li>åœ¨ä¸€å¸§ç©ºé—²æ—¶å¤„ç†, åˆ©ç”¨ <strong>RequestIdleCallback</strong>[4] å¤„ç†ä»»åŠ¡ã€‚</li></ol> <blockquote><p>window.requestIdleCallback()æ–¹æ³•å°†åœ¨æµè§ˆå™¨çš„ç©ºé—²æ—¶æ®µå†…è°ƒç”¨çš„å‡½æ•°æ’é˜Ÿã€‚è¿™ä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œåå°å’Œä½ä¼˜å…ˆçº§å·¥ä½œï¼Œè€Œä¸ä¼šå½±å“å»¶è¿Ÿå…³é”®äº‹ä»¶ï¼Œå¦‚åŠ¨ç”»å’Œè¾“å…¥å“åº”ã€‚å‡½æ•°ä¸€èˆ¬ä¼šæŒ‰å…ˆè¿›å…ˆè°ƒç”¨çš„é¡ºåºæ‰§è¡Œï¼Œç„¶è€Œï¼Œå¦‚æœå›è°ƒå‡½æ•°æŒ‡å®šäº†æ‰§è¡Œè¶…æ—¶æ—¶é—´timeoutï¼Œåˆ™æœ‰å¯èƒ½ä¸ºäº†åœ¨è¶…æ—¶å‰æ‰§è¡Œå‡½æ•°è€Œæ‰“ä¹±æ‰§è¡Œé¡ºåºã€‚</p></blockquote> <ol><li>å¯¹é«˜è€—æ—¶çš„ä»»åŠ¡ï¼Œè¿›è¡Œåˆ†æ­¥éª¤å¤„ç†ã€‚</li></ol> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <ol><li>Web worker è²Œä¼¼ä¹Ÿå¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œè¿™é‡Œä¸åšæ‰©å±•ã€‚</li> <li>...</li></ol> <p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ <strong>RequestIdleCallback</strong>[5] åšä¸ªå®éªŒå’©ã€‚</p> <blockquote><p>Demo: https://linjiayu6.github.io/FE-RequestIdleCallback-demo/</p></blockquote> <blockquote><p>Github: <strong>RequestIdleCallback å®éªŒ</strong>[6]</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>const bindClick = id =&gt;

element(id).addEventListener('click', Work.onAsyncUnit)

// ç»‘å®šclickäº‹ä»¶

bindClick('btnA')

bindClick('btnB')

bindClick('btnC')

var Work = {

// æœ‰1ä¸‡ä¸ªä»»åŠ¡

unit: 10000,

// å¤„ç†æ¯ä¸ªä»»åŠ¡

onOneUnit: function () { for (var i = 0; i &lt;= 500000; i++) {} },

// å¼‚æ­¥å¤„ç†

onAsyncUnit: function () {

// ç©ºé—²æ—¶é—´ 1ms

const FREE_TIME = 1

let _u = 0

function cb(deadline) {

// å½“ä»»åŠ¡è¿˜æ²¡æœ‰è¢«å¤„ç†å®Œ &amp; ä¸€å¸§è¿˜æœ‰çš„ç©ºé—²æ—¶é—´ &gt; 1ms

while (_u &lt; Work.unit &amp;&amp; deadline.timeRemaining() &gt; FREE_TIME) {

Work.onOneUnit()

_u ++

}

// ä»»åŠ¡å¹²å®Œ, æ‰§è¡Œå›è°ƒ

if (_u &gt;= Work.unit) {

// æ‰§è¡Œå›è°ƒ

return

}

// ä»»åŠ¡æ²¡å®Œæˆ, ç»§ç»­ç­‰ç©ºé—²æ‰§è¡Œ

window.requestIdleCallback(cb)

}

window.requestIdleCallback(cb)

}

}
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>requestIdleCallback å¯å‘</p> <p>å°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ†å‰²æˆNä¸ªå°ä»»åŠ¡ï¼Œåœ¨æ¯ä¸€å¸§æœ‰ç©ºä½™æ—¶é—´æƒ…å†µä¸‹ï¼Œé€æ­¥å»æ‰§è¡Œå°ä»»åŠ¡ã€‚</p> <h2 id="_2-react15-æ¶æ„ç¼ºç‚¹"><a href="#_2-react15-æ¶æ„ç¼ºç‚¹" class="header-anchor">#</a> 2.React15 (-) æ¶æ„ç¼ºç‚¹</h2> <blockquote><p><strong>React: stack reconcilerå®ç°</strong>[7]</p></blockquote> <blockquote><p><strong>React ç®—æ³•ä¹‹æ·±åº¦ä¼˜å…ˆéå†</strong>[8]</p></blockquote> <p>é€’å½’ Recursion: åˆ©ç”¨ <strong>è°ƒç”¨æ ˆ</strong>[9]ï¼Œå®ç°è‡ªå·±è°ƒç”¨è‡ªå·±çš„æ–¹æ³•ã€‚</p> <p>æœ€å¸¸è§çš„å°±æ˜¯ <strong>Leetcode: æ–æ³¢æ‹‰å¥‘æ•°åˆ—</strong>[10] ã€<strong>Leetcode: 70. çˆ¬æ¥¼æ¢¯</strong>[11]ã€‚</p> <h3 id="_2-1-æ¦‚è¿°åŸå› "><a href="#_2-1-æ¦‚è¿°åŸå› " class="header-anchor">#</a> 2.1 æ¦‚è¿°åŸå› </h3> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>è¯¥æƒ…å†µï¼Œç±»ä¼¼æˆ‘ä»¬ä¸Šè¿°# 1.3ä¸¢å¸§å®éªŒã€‚</p> <h3 id="_2-2-æµç¨‹å’Œä»£ç è§£æ"><a href="#_2-2-æµç¨‹å’Œä»£ç è§£æ" class="header-anchor">#</a> 2.2 æµç¨‹å’Œä»£ç è§£æ</h3> <blockquote><p>å¯èƒ½éœ€è¦ä½ æœ‰ç‚¹ æ·±åº¦ä¼˜å…ˆéå†ã€é€’å½’ã€å›æº¯æ€æƒ³ã€ğŸŒ² ç­‰æ•°æ®ç»“æ„çš„çŸ¥è¯†ã€‚</p></blockquote> <blockquote><p>è¿™é‡Œåªåšæµç¨‹è§£æï¼Œä»£ç ä¹Ÿä¸ºé˜‰å‰²ç‰ˆï¼Œé‡ç‚¹æ˜¯ç†è§£æ€æƒ³å“ˆã€‚</p></blockquote> <p>æŸReactèŠ‚ç‚¹å¦‚ä¸‹:</p> <div class="language- extra-class"><pre class="language-text"><code>  class A extends React.Component {

    ...



    render() {

      return (

        &lt;div id=&quot;app&quot;&gt;

          &lt;h1&gt;&lt;/h1&gt;

          &lt;p&gt;&lt;h2&gt;&lt;/h2&gt;&lt;/p&gt;

          &lt;h3&gt;&lt;/h3&gt;

        &lt;/div&gt;

      )

    }

 }
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>å›¾ DFS + é€’å½’éå†çš„è·¯å¾„</p> <p>ä¸‹é¢æ˜¯ <strong>ReactFiberWorkLoop.old.js</strong>[12] é˜‰å‰²ç‰ˆä»£ç ï¼Œä¸ºäº†ç®€è¦è¯´æ˜è¯¥æµç¨‹ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// å·¥ä½œå¾ªç¯åŒæ­¥å¤„ç†

function workLoopSync() {

  // æœ‰ä»»åŠ¡

  while (workInProgress !== null) {

    performUnitOfWork(workInProgress);

  }

}



function performUnitOfWork(unitOfWork: Fiber): void {

  // å¯¹è¯¥èŠ‚ç‚¹ å¼€å§‹å·¥ä½œ: return workInProgress.child; è¿”å›çš„æ˜¯è¯¥èŠ‚ç‚¹çš„å­©å­

  let next = beginWork(...);



  if (next === null) {

    // å¯¹æŸNode å®Œæˆå·¥ä½œ: å›æº¯å‘ä¸Š, å‘ä¸Šæ‰¾åˆ°æŸèŠ‚ç‚¹çš„å…„å¼Ÿ sibling æˆ– ç›´åˆ°å‘ä¸Šä¸ºrootä»£è¡¨, éå†ç»“æŸã€‚

    completeUnitOfWork(unitOfWork);

  } else {

    // ä»ta å­©å­å…¥æ‰‹, ç»§ç»­å‘ä¸‹å·¥ä½œ

    workInProgress = next;

  }

}



/**

 * siblingFiber: å…„å¼ŸèŠ‚ç‚¹

 * returnFiber: çˆ¶äº²èŠ‚ç‚¹

 */

function completeUnitOfWork(unitOfWork: Fiber): void {

  let completedWork = unitOfWork;



  // è¿™é‡Œåˆæ˜¯ä¸€ä¸ªå¾ªç¯

  do {

    // 1. åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆ, å®Œæˆå°±æ‰“ä¸ªå®Œæˆçš„æ ‡ç­¾, æ²¡æœ‰å®Œæˆå°±æŠ›å‡ºå¼‚å¸¸



    // 2. å¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹, é‚£ä¹ˆæ¥ä¸‹æ¥å·¥ä½œèŠ‚ç‚¹æ˜¯è¯¥ xd

    if (completedWork.sibling !== null) {

      workInProgress = siblingFiber;

      return;

    }



    // 3. å¦åˆ™, è¿”å›çˆ¶äº²èŠ‚ç‚¹

    completedWork = completedWork.return;

    workInProgress = completedWork;

  } while (completedWork !== null);



  // æœ€å, æ˜¯rootèŠ‚ç‚¹, ç»“æŸ

  if (workInProgressRootExitStatus === RootIncomplete) {

    workInProgressRootExitStatus = RootCompleted;

  }

}
</code></pre></div><h2 id="_3-ä¸Šè¿°æ€»ç»“"><a href="#_3-ä¸Šè¿°æ€»ç»“" class="header-anchor">#</a> 3.ä¸Šè¿°æ€»ç»“</h2> <p><strong>å› æœå…³ç³»</strong></p> <p>åŸºäºè¿™äº›åŸå› ï¼ŒReactä¸å¾—ä¸é‡æ„æ•´ä¸ªæ¡†æ¶ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>1. React (15ver-) å¯¹åˆ›å»ºå’Œæ›´æ–°èŠ‚ç‚¹çš„å¤„ç†ï¼Œæ˜¯é€šè¿‡ é€’å½’ ğŸŒ²ã€‚

2. é€’å½’ ï¼Œ åœ¨æœªå®Œæˆå¯¹æ•´ä¸ªğŸŒ² çš„éå†å‰ï¼Œæ˜¯ä¸ä¼šåœæ­¢çš„ã€‚

3. è¯¥ ä»»åŠ¡ ä¸€ç›´å ç”¨æµè§ˆå™¨ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´æ—  å“åº”ä¼˜å…ˆçº§æ›´é«˜ çš„ä»»åŠ¡ã€‚

4. æ•…ï¼Œæµè§ˆå™¨æ¸²æŸ“è¶…è¿‡ä¸´ç•Œæ—¶é—´ï¼Œä»è§†è§‰ä¸Šæ¥çœ‹ï¼Œå¡æ­» ğŸ¶ã€‚
</code></pre></div><p><strong>ä¸»åŠ¨æ€è€ƒ</strong></p> <div class="language- extra-class"><pre class="language-text"><code>ä¸ºäº†å¿«é€Ÿå“åº”ï¼Œé˜²æ­¢ä¸¢å¸§ï¼Œè§£å†³æ€è·¯:


1. å°† ä»»åŠ¡ åˆ†è§£æˆ Nä¸ªå°ä»»åŠ¡ï¼›

2. If ä¸€å¸§é‡Œæ²¡æœ‰ ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼Œåˆ™æ‰§è¡Œè‡ªå·±ã€‚

   else æœ‰å…¶ä»– ä¼˜å…ˆçº§é«˜çš„äº‹åŠ¡, ä¼˜å…ˆæ‰§è¡Œå…¶ä»–ã€‚

     If ç­‰ä¸€å¸§æœ‰ ç©ºé—² å†æ‰§è¡Œè‡ªå·±ã€‚

     else ä¸‹ä¸€å¸§ã€‚
</code></pre></div><p>æˆ‘ä»¬å†å›å¤´çœ‹ä¸‹è¿™ä¸ªå›¾ï¼Œé—®é¢˜å³è½¬æ¢å¦‚ä¸‹:</p> <div class="language- extra-class"><pre class="language-text"><code>å¦‚ä½•å°†ä»»åŠ¡æ‹†åˆ†ï¼Ÿ

å¦‚ä½•åˆ¤æ–­ä¼˜å…ˆçº§ï¼Ÿ

å¦‚ä½•åˆ¤æ–­ä¸€å¸§ç©ºé—²æ—¶ï¼Œå†æ‰§è¡Œï¼Ÿ

...
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h1 id="fiber-æ¶æ„"><a href="#fiber-æ¶æ„" class="header-anchor">#</a> Fiber æ¶æ„</h1> <blockquote><p>æ¨è ğŸ‘ https://github.com/7kms/react-illustration-series/tree/v17.0.1</p></blockquote> <blockquote><p>æ¨è ğŸ‘ https://react.iamkasong.com/preparation/oldConstructure.html</p></blockquote> <p>ä¸‹é¢ï¼Œä¸ä¼šæœ‰å¤§æ®µå¤§æ®µä»£ç ï¼Œå»è®²å…·ä½“çš„å®ç°ã€‚</p> <p>è€Œæ˜¯ï¼Œä»¥å› æœé€»è¾‘ï¼Œå¸¦ä½ å»äº†è§£ whyï¼Œhowï¼Œwhen (ä¸ºä»€ä¹ˆã€æ€ä¹ˆåšã€ä½•æ—¶åš)ã€‚</p> <h2 id="_4-æŠ½è±¡é—®é¢˜"><a href="#_4-æŠ½è±¡é—®é¢˜" class="header-anchor">#</a> 4.æŠ½è±¡é—®é¢˜</h2> <p>ä¸Šé¢æˆ‘ä»¬è¯´åˆ°äº†ä»€ä¹ˆä»»åŠ¡ã€ä¼˜å…ˆçº§ç­‰ç­‰ï¼Œæˆ‘ä»¬é€šè¿‡å›¾çš„æ–¹å¼ï¼ŒæŠ½è±¡ä¸‹é—®é¢˜ã€‚</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <div class="language- extra-class"><pre class="language-text"><code>æè¿°:

1. ä»»åŠ¡Aè¿›å…¥æ‰§è¡ŒåŒºåŸŸã€‚

2. åœ¨æ‰§è¡Œä»»åŠ¡Açš„è¿‡ç¨‹ä¸­ï¼Œæ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡Bï¼Œè¯·æ±‚è¢«æ‰§è¡Œã€‚

3. ä½†å› ä¸ºå…ˆæ¥ååˆ°å˜›ï¼Œæ­¤æ—¶ä»»åŠ¡Bå› ä¸ºæ— æ³•è¢«æ‰§è¡Œï¼Œè€Œæš‚æ—¶è¢«æŒ‚èµ·ï¼Œåªèƒ½ç­‰å¾…æ‰§è¡Œã€‚

4. åªæœ‰æ‰§è¡Œå®Œä»»åŠ¡Aåï¼Œæ‰ä¼šæ‰§è¡Œä»»åŠ¡Bã€‚
</code></pre></div><p><strong>ä¸Šè¿°æµç¨‹å¯ç±»æ¯”:</strong> ä½ åœ¨åƒé¥­ï¼Œçªç„¶ä½ è€æ¿ ç»™ä½ æ‰“ç”µè¯ï¼Œä½ ä¸€å®šè¦åšæŒåƒå®Œé¥­ï¼Œæ‰æ¥ä½ è€æ¿çš„ç”µè¯ã€‚</p> <p>(è„‘è¡¥ä¸€ä¸‹è€æ¿çš„è¡¨æƒ…ğŸ˜­)</p> <p>å¾ˆæ˜æ˜¾ï¼Œè¿™æ ·å¤„ç†é—®é¢˜ï¼Œæ•ˆç‡å¥‡ä½æ— æ¯”ã€‚</p> <p>æŒ‰ç…§æˆ‘ä»¬åœ¨å‰æƒ…æ€»ç»“éƒ¨åˆ†çš„è¯‰æ±‚ï¼Œå°†ä¸Šè¿°å›¾å˜æˆè¿™æ ·æ˜¯ä¸æ˜¯æ›´åˆç†äº›ã€‚</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <div class="language- extra-class"><pre class="language-text"><code>æè¿°:

1. ä»»åŠ¡Aè¿›å…¥æ‰§è¡ŒåŒºåŸŸã€‚

2. åœ¨æ‰§è¡Œä»»åŠ¡Açš„è¿‡ç¨‹ä¸­ï¼Œæ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡Bï¼Œè¯·æ±‚è¢«æ‰§è¡Œã€‚

3. è€ƒè™‘åˆ°ä»»åŠ¡Bä¼˜å…ˆçº§æ›´é«˜ï¼Œåˆ™å°†ä»»åŠ¡Aæ²¡æœ‰æ‰§è¡Œå®Œæˆçš„éƒ¨åˆ†ï¼ŒStashæš‚å­˜ã€‚

4. ä»»åŠ¡Bè¢«æ‰§è¡Œã€‚å½“ä»»åŠ¡Bè¢«æ‰§è¡Œå®Œæˆåï¼Œå»æ‰§è¡Œå‰©ä½™æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡Aã€‚
</code></pre></div><p><strong>ä¸Šè¿°æµç¨‹å¯ç±»æ¯”:</strong> ä½ åœ¨åƒé¥­ï¼Œçªç„¶ä½ è€æ¿ç»™ä½ æ‰“ç”µè¯ï¼Œå³ä½¿ä½ æ²¡æœ‰åƒå®Œé¥­ï¼Œä¹Ÿæ¥èµ·äº†ä½ è€æ¿çš„ç”µè¯ï¼Œåç»§ç»­åƒé¥­ã€‚(è„‘è¡¥ä¸€ä¸‹è€æ¿çš„è¡¨æƒ…ğŸ˜Š)</p> <h2 id="_5-æ ¸å¿ƒå…³æ³¨"><a href="#_5-æ ¸å¿ƒå…³æ³¨" class="header-anchor">#</a> 5.æ ¸å¿ƒå…³æ³¨</h2> <h3 id="_5-1-å¹¶å‘ã€è°ƒåº¦"><a href="#_5-1-å¹¶å‘ã€è°ƒåº¦" class="header-anchor">#</a> 5.1 å¹¶å‘ã€è°ƒåº¦</h3> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>Concurrency &amp; Scheduler</p> <p><strong>Concurrency å¹¶å‘:</strong> æœ‰èƒ½åŠ›ä¼˜å…ˆå¤„ç†æ›´é«˜ä¼˜äº‹åŠ¡ï¼ŒåŒæ—¶å¯¹æ­£åœ¨æ‰§è¡Œçš„ä¸­é€”ä»»åŠ¡å¯æš‚å­˜ï¼Œå¾…é«˜ä¼˜å®Œæˆåï¼Œå†å»æ‰§è¡Œã€‚</p> <blockquote><p><strong>concurrency</strong> is the ability of different parts or units of a <strong>program</strong>[13], <strong>algorithm</strong>[14], or <strong>problem</strong>[15] to be [executed](https://en.wikipedia.org/wiki/Execution_(computing &quot;executed&quot;)) out-of-order or at the same time simultaneously <strong>partial order</strong>[16], without affecting the final outcome.</p></blockquote> <blockquote><p>https://en.wikipedia.org/wiki/Concurrency_(computer_science)</p></blockquote> <p><strong>Scheduler åè°ƒè°ƒåº¦</strong>: æš‚å­˜æœªæ‰§è¡Œä»»åŠ¡ï¼Œç­‰å¾…æ—¶æœºæˆç†Ÿåï¼Œå†å»å®‰æ’æ‰§è¡Œå‰©ä¸‹æœªå®Œæˆä»»åŠ¡ã€‚</p> <p>è€ƒè™‘ æ‰€æœ‰ä»»åŠ¡å¯ä»¥è¢«å¹¶å‘æ‰§è¡Œï¼Œå°±éœ€è¦æœ‰ä¸ªåè°ƒä»»åŠ¡çš„è°ƒåº¦ç®—æ³•ã€‚</p> <p>çœ‹åˆ°è¿™é‡Œï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªå¤§bugã€‚</p> <p>è‚¯å®šæ˜¯<strong>Call Stack</strong>[17]ã€‚</p> <h3 id="_5-2-è°ƒç”¨æ ˆã€è™šæ‹Ÿè°ƒç”¨æ ˆå¸§"><a href="#_5-2-è°ƒç”¨æ ˆã€è™šæ‹Ÿè°ƒç”¨æ ˆå¸§" class="header-anchor">#</a> 5.2 è°ƒç”¨æ ˆã€è™šæ‹Ÿè°ƒç”¨æ ˆå¸§</h3> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>è°ƒç”¨æ ˆè¿™é‡Œçœ‹èµ·æ¥å°±å¾ˆä¸åˆç†ã€‚</p> <p>å› ä¸ºæµè§ˆå™¨æ˜¯åˆ©ç”¨è°ƒç”¨æ ˆæ¥ç®¡ç†å‡½æ•°æ‰§è¡Œé¡ºåºçš„ï¼Œç§‰æ‰¿ç€å…ˆè¿›åå‡ºåŸåˆ™ï¼Œæ˜¯å¦‚ä½•åšåˆ°æŸä»»åŠ¡éƒ½å…¥æ ˆäº†ï¼Œä½†æ˜¯å› ä¸ºä¸­é€”æœ‰å…¶ä»–äº‹å„¿ï¼Œå°±è¢«ä¸­æ–­ã€‚ä¸­æ–­å°±ä¸ç®—äº†ï¼Œè¿˜èƒ½ä¸­æ–­åï¼Œæ¥ç€åç»­å†æ‰§è¡Œã€‚</p> <p><strong>é—®é¢˜çªç„¶é—´å°±å˜æˆ: pause a functioin call (æš‚åœå¯¹ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨)ã€‚</strong></p> <p>å·§äº†ï¼Œåƒ generator å’Œ æµè§ˆå™¨debugger å°±å¯ä»¥åšåˆ°ä¸­æ–­å‡½æ•°è°ƒç”¨ã€‚ä½†è€ƒè™‘åˆ°å¯ä¸­æ–­æ¸²æŸ“ï¼Œå¹¶å¯é‡å›æ„é€ ã€‚Reactè‡ªè¡Œå®ç°äº†ä¸€å¥—ä½“ç³»å«åš <strong>React fiber æ¶æ„ã€‚</strong></p> <p><strong>React Fiber æ ¸å¿ƒ: è‡ªè¡Œå®ç° è™šæ‹Ÿæ ˆå¸§ã€‚</strong></p> <blockquote><p>That's the purpose of React Fiber. Fiber is reimplementation of the stack, specialized for React components. You can think of a single fiber as a <strong>virtual stack frame</strong>.</p></blockquote> <blockquote><p>https://github.com/acdlite/react-fiber-architecture</p></blockquote> <p>çœ‹åˆ°è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯è§‰å¾— React yydsã€‚ps: åæ­£çœ‹ä¸å¤ªæ‡‚çš„éƒ½æ˜¯ yydsã€‚</p> <h3 id="_5-3-react-16-æ¶æ„"><a href="#_5-3-react-16-æ¶æ„" class="header-anchor">#</a> 5.3 React 16 (+) æ¶æ„</h3> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h2 id="_6-æ•°æ®ç»“æ„"><a href="#_6-æ•°æ®ç»“æ„" class="header-anchor">#</a> 6.æ•°æ®ç»“æ„</h2> <blockquote><p><strong>FiberNode.js</strong>[18]</p></blockquote> <p>Fiberçš„æ•°æ®ç»“æ„æœ‰ä¸‰å±‚ä¿¡æ¯: å®ä¾‹å±æ€§ã€æ„å»ºå±æ€§ã€å·¥ä½œå±æ€§ã€‚</p> <p>ä¸‹é¢ä»¥è¯¥demoä»£ç ä¸ºä¾‹:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;div id=&quot;linjiayu&quot;&gt;123&lt;/div&gt;

&lt;script type=&quot;text/babel&quot;&gt;

    const App = () =&gt; {

        const [sum, onSetSum] = React.useState(0)



        return (

            &lt;div id=&quot;app 1&quot;&gt;

                &lt;h1 id=&quot;2-1 h1&quot;&gt;æ ‡é¢˜ h1&lt;/h1&gt;

                &lt;ul id=&quot;2-2 ul&quot;&gt; 

                    &lt;li id=&quot;3-1 li&quot; onClick={() =&gt; onSetSum(d =&gt; d + 1)}&gt;ç‚¹å‡» h2&lt;/li&gt;

                    &lt;li id=&quot;3-2 li&quot;&gt;{sum}&lt;/li&gt;

                &lt;/ul&gt;



                &lt;h3 id=&quot;2-3 h3&quot;&gt;æ ‡é¢˜ h3&lt;/h3&gt;

            &lt;/div&gt;

        )

    }



    ReactDOM.render(

        &lt;App /&gt;,

        document.getElementById('linjiayu')

    );

&lt;/script&gt;
</code></pre></div><h3 id="_6-1-å®ä¾‹å±æ€§"><a href="#_6-1-å®ä¾‹å±æ€§" class="header-anchor">#</a> 6.1 å®ä¾‹å±æ€§</h3> <p>è¯¥Fiberçš„åŸºæœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚ç»„ä»¶ç±»å‹ç­‰ã€‚</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h3 id="_6-2-æ„å»ºå±æ€§"><a href="#_6-2-æ„å»ºå±æ€§" class="header-anchor">#</a> 6.2 æ„å»ºå±æ€§</h3> <p>æ„å»ºå±æ€§ (returnã€childã€sibling)ï¼Œæ ¹æ®ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªFiberæ ‘ğŸŒ²ã€‚</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h4 id="æ„å»ºæµç¨‹"><a href="#æ„å»ºæµç¨‹" class="header-anchor">#</a> æ„å»ºæµç¨‹</h4> <p>å’Œ 2.2 æµç¨‹å’Œä»£ç è§£æ éƒ¨åˆ†ä¸åŒçš„æ˜¯:</p> <ol><li>åˆ†ä¸ºåŒæ­¥æˆ–å¼‚æ­¥æ›´æ–°ã€‚</li> <li>ä¸”å¢åŠ çš„å¼‚æ­¥æ›´æ–° ä½¿ç”¨è¯¥å­—æ®µ <strong>shouldYield</strong> æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// performSyncWorkOnRootä¼šè°ƒç”¨è¯¥æ–¹æ³•

function workLoopSync() {

  while (workInProgress !== null) {

    performUnitOfWork(workInProgress);

  }

}



// performConcurrentWorkOnRootä¼šè°ƒç”¨è¯¥æ–¹æ³•

function workLoopConcurrent() {

  while (workInProgress !== null &amp;&amp; ! shouldYield ()) {

    performUnitOfWork(workInProgress);

  }

}
</code></pre></div><p>åœ¨ä¸€ä¸ªé€’å½’å¾ªç¯é‡Œï¼Œé€’: <strong>beginWork()</strong>[19], å½’ <strong>completeWork()</strong>[20]</p> <blockquote><p>è™šçº¿: è¡¨è¾¾æ„å»ºå…³ç³»ï¼Œä½†æœªå®ŒæˆçŠ¶æ€ã€‚</p></blockquote> <blockquote><p>å®çº¿: å·²æ„å»ºå…³ç³»ï¼Œå¹¶å·²æ‰§è¡ŒæŸä¸ªçŠ¶æ€ã€‚</p> <ul><li>å®çº¿ child å’Œ sibling å·²æ‰§è¡ŒbeginWork()</li> <li>å®çº¿ return å·²æ‰§è¡Œ completeUnitOfWork()</li></ul></blockquote> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <div class="language- extra-class"><pre class="language-text"><code>1. åˆ›å»ºfiberNode FiberRootNode 

2. åˆ›å»ºfiberNode rootFiber (å³ç¤ºä¾‹ä¸­ &lt;div id=&quot;linjiayu&quot;&gt;)



è¿›å…¥å¾ªç¯å·¥ä½œåŒºåŸŸ, workInProgress(å·¥ä½œæŒ‡é’ˆæŒ‡å‘ rootFiber)

3. åˆ›å»ºfiberNode App 

   beginWork() -&gt; åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ -&gt; workInProgress(å·¥ä½œæŒ‡é’ˆæŒ‡å‘App) 

   

4. åˆ›å»ºfiberNode div 

   beginWork() -&gt; æœ‰å¤šä¸ªå­èŠ‚ç‚¹ -&gt; workInProgress(å·¥ä½œæŒ‡é’ˆæŒ‡å‘div) 
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <div class="language- extra-class"><pre class="language-text"><code>5. æ„å»ºå­©å­ä»¬èŠ‚ç‚¹

æŒ‰ç…§5.1 -&gt; 5.2 -&gt; 5.3 é¡ºåºå°†æ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºã€‚
</code></pre></div><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <div class="language- extra-class"><pre class="language-text"><code>6. workInProgress (å·¥ä½œæŒ‡é’ˆæŒ‡å‘h1)

   beginWork() -&gt; æ²¡æœ‰å­èŠ‚ç‚¹ -&gt; completeUnitOfWork() -&gt; æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œç»§ç»­ ...
</code></pre></div><h3 id="_6-3-å·¥ä½œå±æ€§"><a href="#_6-3-å·¥ä½œå±æ€§" class="header-anchor">#</a> 6.3 å·¥ä½œå±æ€§</h3> <ol><li>ã€æ•°æ®ã€‘æ•°æ®çš„å˜æ›´ä¼šå¯¼è‡´UIå±‚çš„å˜æ›´ã€‚</li> <li>ã€åè°ƒã€‘ä¸ºäº†å‡å°‘å¯¹DOMçš„ç›´æ¥æ“ä½œï¼Œé€šè¿‡Reconcileè¿›è¡ŒdiffæŸ¥æ‰¾ï¼Œå¹¶å°†éœ€è¦å˜æ›´èŠ‚ç‚¹ï¼Œæ‰“ä¸Šæ ‡ç­¾ï¼Œå˜æ›´è·¯å¾„ä¿ç•™åœ¨effectListé‡Œã€‚</li> <li>ã€è°ƒåº¦ã€‘å¾…å˜æ›´å†…å®¹è¦æœ‰Schedulerä¼˜å…ˆçº§å¤„ç†ã€‚</li></ol> <p>æ•…ï¼Œæ¶‰åŠåˆ°diffç­‰æŸ¥æ‰¾æ“ä½œï¼Œæ˜¯éœ€è¦æœ‰ä¸ªé«˜æ•ˆæ‰‹æ®µæ¥å¤„ç†å‰åå˜åŒ–ï¼Œå³åŒç¼“å­˜æœºåˆ¶ã€‚</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>æœ‰å…³åŒç¼“å­˜æœºåˆ¶ã€æ•°æ®æ›´æ–°ã€diffç®—æ³•ç­‰ï¼Œè¿™é‡Œä¸åšè¿‡å¤šä»‹ç»ã€‚</p> <h2 id="_7-reconciler-å’Œ-scheduler"><a href="#_7-reconciler-å’Œ-scheduler" class="header-anchor">#</a> 7.Reconciler å’Œ Scheduler</h2> <p>ä¸Šé¢ï¼Œæˆ‘ä»¬æ¦‚è¿°äº†fiberNodeçš„æ•°æ®ç»“æ„ï¼Œ<strong>é“¾è¡¨ç»“æ„å³å¯æ”¯æŒéšæ—¶éšæ—¶ä¸­æ–­çš„è¯‰æ±‚</strong>ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬ç®€è¿°ä¸‹æ¶æ„ä¸­ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—:</p> <ul><li>Reconciler (åè°ƒ): è´Ÿè´£æ‰¾å‡ºå˜åŒ–çš„ç»„ä»¶ã€‚</li> <li>Scheduler (è°ƒåº¦): è´Ÿè´£æ‰¾å‡ºé«˜ä¼˜ä»»åŠ¡ã€‚</li></ul> <h3 id="_7-1-reconciler-è¿è¡Œæµç¨‹æµ…æ"><a href="#_7-1-reconciler-è¿è¡Œæµç¨‹æµ…æ" class="header-anchor">#</a> 7.1 Reconciler è¿è¡Œæµç¨‹æµ…æ</h3> <ol><li><strong>ã€è¾“å…¥ã€‘</strong> å½“æ•°æ®åˆå§‹åŒ–æˆ–å˜åŒ–ï¼Œæœ€åä¼šè°ƒç”¨<code>schedulerUpdateOnFiber</code>è¯¥æ–¹æ³•ã€‚</li></ol> <ul><li>ä¸éœ€è¦è°ƒåº¦ï¼Œç›´æ¥å»æ„é€ fiberæ ‘ã€‚</li> <li>éœ€è¦è°ƒåº¦ï¼Œæ³¨å†Œè°ƒåº¦ä»»åŠ¡ã€‚</li></ul> <div class="language- extra-class"><pre class="language-text"><code>// scheduleUpdateOnFiber(fiber, lane, eventTime) ä»¥ä¸‹ä¸ºé˜‰å‰²ç‰ˆä»£ç 

// åŒæ­¥

if (lane === SyncLane) {

    if ( 

       // Check if we're inside unbatchedUpdates (æ²¡æœ‰ä¸€æ¬¡äº‹ä»¶å›è°ƒä¸­è§¦å‘å¤šæ¬¡æ›´æ–°)

      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp; 

      // Check if we're not already rendering (æ˜¯å¦å°šæœªæ¸²æŸ“)

      (executionContext &amp; (RenderContext | CommitContext)) === NoContext) {

      // ä¸è°ƒåº¦, ç›´æ¥å»æ„é€ fiberæ ‘

      performSyncWorkOnRoot(root);

   }

}



// å¦åˆ™ï¼Œéœ€è¦è°ƒåº¦äº¤ç»™Scheduleråï¼Œå†å»æ„é€ fiberæ ‘

ensureRootIsScheduled(root, eventTime);
</code></pre></div><ol><li><strong>ã€æ³¨å†Œä»»åŠ¡ã€‘</strong> <code>ensureRootIsScheduled</code></li></ol> <p>ä¸¤ç±»ä»»åŠ¡:</p> <ul><li>performSyncWorkOnRoot åŒæ­¥æ„å»ºtreeã€‚</li> <li>performConcurrentWorkOnRoot å¼‚æ­¥æ„å»ºtreeã€‚</li></ul> <p>scheduleSyncCallback æˆ– scheduleCallback: å°†ä¸Šè¿°ä¸¤ç±»ä»»åŠ¡å°è£…åˆ°äº†å¯¹åº”çš„<strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ä¸­ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// ensureRootIsScheduled

function ensureRootIsScheduled(root, currentTime) {

    // ....

    

    // 1. ä¼˜å…ˆçº§æœ€é«˜ï¼Œç«‹åˆ»é©¬ä¸Šè¦åŒæ­¥æ‰§è¡Œ

    if (newCallbackPriority === SyncLanePriority) {

      newCallbackNode = scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));

     // 2. åŒæ­¥æ‰¹é‡æ›´æ–°

    } else if (newCallbackPriority === SyncBatchedLanePriority) {

      newCallbackNode = scheduleCallback(ImmediatePriority$1, performSyncWorkOnRoot.bind(null, root));

    } else {

      // 3. å¼‚æ­¥ä¼˜å…ˆçº§ç™»è®°

      var schedulerPriorityLevel = lanePriorityToSchedulerPriority(newCallbackPriority);

      newCallbackNode = scheduleCallback(schedulerPriorityLevel, performConcurrentWorkOnRoot.bind(null, root));

    }

    

    // ...

    

    // æ›´æ–°rootFiber ä»»åŠ¡

    root.callbackNode = newCallbackNode;

}
</code></pre></div><p>åŒæ­¥ä»»åŠ¡ä¼šæ”¾åˆ°syncQueue é˜Ÿåˆ—ï¼Œä¼šè¢«ç«‹å³è¢«æ‰§è¡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>var _queue = syncQueue;



// æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡

runWithPriority(ImmediatePriority, () =&gt; {

    for (; i &lt; queue.length; i++) {

    let callback = queue[i];

    do {

        callback = callback(isSync);

    } while (callback !== null);

    }

});

// æ¸…ç©ºåŒæ­¥ä»»åŠ¡

syncQueue = null;
</code></pre></div><p>å¼‚æ­¥å¤„ç†ä¼šè°ƒç”¨ scheduleræ–¹æ³• <code>unstable_scheduleCallback</code>ï¼Œå…¶å®æ˜¯requestIdleCallbackæ›¿ä»£å“ï¼Œè¯¥æ–¹æ³•ä¼ å…¥å›è°ƒä»»åŠ¡ï¼Œå’Œè¿‡æœŸæ—¶é—´ï¼Œæ¥å®‰æ’ä»»åŠ¡çš„æ‰§è¡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>function unstable_scheduleCallback(callback, deprecated_options) {}
</code></pre></div><ol><li><strong>ã€æ‰§è¡Œä»»åŠ¡å›è°ƒã€‘</strong></li></ol> <p>ä¸‹é¢ <code>performSyncWorkOnRoot</code> å’Œ <code>performConcurrentWorkOnRoot</code> ä¸åŒçš„æ˜¯: å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œå¯éšæ—¶ä¸­æ–­æ¸²æŸ“ shouldYield()</p> <p>åŒæ­¥æ‰§è¡Œæ„å»ºæ ‘</p> <div class="language- extra-class"><pre class="language-text"><code>function performSyncWorkOnRoot(root) {

  // 1. æ„å»ºæ ‘

  /*

    renderRootSync ä¼š è°ƒç”¨è¯¥æ–¹æ³• workLoopSync

    while (workInProgress !== null) {

      performUnitOfWork(workInProgress);

    }

  */

  renderRootSync(root, lanes)

  

  // 2. è¾“å‡ºæ ‘ (å¯çœ‹ä¸‹åŒç¼“å­˜æœºåˆ¶)

  finishedWork = root.current.alternate;

}
</code></pre></div><p>å¼‚æ­¥æ‰§è¡Œæ„å»ºæ ‘</p> <div class="language- extra-class"><pre class="language-text"><code>function performConcurrentWorkOnRoot(root) {

   // 1. æ„å»ºæ ‘

   /*

    renderRootConcurrent ä¼š è°ƒç”¨è¯¥æ–¹æ³• workLoopConcurrent

    while (workInProgress !== null &amp;&amp;  !shouldYield() ) {

      performUnitOfWork(workInProgress);

    }

  */

   renderRootConcurrent(root, lanes);

   // 2. è¾“å‡ºæ ‘ (å¯çœ‹ä¸‹åŒç¼“å­˜æœºåˆ¶)

   finishConcurrentRender(root, exitStatus, lanes);

   

   // 3. check æ˜¯å¦è¿˜æœ‰å…¶ä»–æ›´æ–°, æ˜¯å¦éœ€è¦å‘èµ·æ–°è°ƒåº¦

   ensureRootIsScheduled(root, now());

    if (root.callbackNode === originalCallbackNode) {

      // å½“å‰æ‰§è¡Œçš„ä»»åŠ¡è¢«ä¸­æ–­ï¼Œè¿”å›ä¸ªæ–°çš„ï¼Œå†æ¬¡æ¸²æŸ“ã€‚

      return performConcurrentWorkOnRoot.bind(null, root);

    }



    return null;

}
</code></pre></div><ol><li>ã€<strong>è¾“å‡º</strong>ã€‘</li></ol> <p>å°†å˜æ›´å†…å®¹ï¼Œè¾“å‡ºè‡³ç•Œé¢ã€‚è¯¦ç»†çœ‹ <code>commitRoot</code>æ–¹æ³•çš„å®ç°ã€‚è¿™é‡Œä¸åšæ‰©å±•ã€‚</p> <ol><li>å°æ€»ç»“</li></ol> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h3 id="_7-2-scheduler-è¿è¡Œæµç¨‹æµ…æ"><a href="#_7-2-scheduler-è¿è¡Œæµç¨‹æµ…æ" class="header-anchor">#</a> 7.2 Scheduler è¿è¡Œæµç¨‹æµ…æ</h3> <blockquote><p><strong>workloop.js</strong>[21]</p></blockquote> <p>ä¸Šé¢æˆ‘ä»¬è¯´åˆ°äº†åŒæ­¥å’Œå¼‚æ­¥çš„ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡æ˜¯å¯ä»¥ä¸­æ–­ä¸”éœ€è¦Scheduleré…åˆå¤„ç†ã€‚</p> <p>æ³¨æ„åªæœ‰å¼‚æ­¥ä»»åŠ¡å³å¼€å¯äº†å¹¶å‘æ¨¡å¼ï¼Œæ‰ä¼šæœ‰æ—¶é—´åˆ†ç‰‡ã€‚</p> <p>workLoopæ˜¯ å®ç°æ—¶é—´åˆ‡ç‰‡ å’Œ å¯ä¸­æ–­æ¸²æŸ“çš„æ ¸å¿ƒã€‚ä¹Ÿæ˜¯æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„<strong>è™šæ‹Ÿæ ˆå¸§</strong>çš„èƒ½åŠ› <strong>ã€‚</strong></p> <p>ä»¥ä¸‹ä¸ºäº†è¯´æ˜ï¼Œç®€åŒ–æµç¨‹:</p> <div class="language- extra-class"><pre class="language-text"><code>// å¹¶å‘ä»»åŠ¡çš„å…¥å£

function workLoopConcurrent() {

  // Perform work until Scheduler asks us to yield

  // æœ‰ä»»åŠ¡ &amp; æ˜¯å¦éœ€è¦ä¸­æ–­

  while (workInProgress !== null &amp;&amp; !shouldYield() ) {

    performUnitOfWork(workInProgress);

  }

}

const scheduler = {

    // ä»»åŠ¡æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…ç©ºé—²æ‰§è¡Œ

    taskQueue: [

       {

          // æ¯ä¸ªä»»åŠ¡æ˜¯ä¸ªå›è°ƒçš„æ¦‚å¿µ, ä¸”å›è°ƒä»»åŠ¡æ˜¯å¯ä¸­æ–­çš„

          callback: workLoopConcurrent

       }

    ],


    // åˆ¤æ–­: æ˜¯å¦éœ€è¦ä¸­æ–­, å°†æ§åˆ¶æƒäº¤ç»™ä¸»è¿›ç¨‹

    shouldYieldToHost () {

        // æ²¡æœ‰å‰©ä½™æ—¶é—´

        if (currentTime &gt;= deadline) {

            // ä½†éœ€è¦æ¸²æŸ“ å’Œ æœ‰æ›´é«˜ä¼˜ä»»åŠ¡

            if (needsPaint || scheduling.isInputPending()) {

                return true; // ä¸­æ–­

            }

            // æ˜¯å¦è¶…è¿‡ 300ms

            return currentTime &gt;= maxYieldInterval;

        }


        // è¿˜æœ‰å‰©ä½™æ—¶é—´

        return false;

    },


    // æ‰§è¡Œå…¥å£å¯è§

    workLoop () {

        // å½“å‰ç¬¬ä¸€ä¸ªä»»åŠ¡

        currentTask = taskQueue[0];

 
        // æ¯æ¬¡ currentTask é€€å‡º å°±æ˜¯ä¸€ä¸ªæ—¶é—´åˆ‡åˆ‡ç‰‡

        while(currentTask !== null) {

            // ä»»åŠ¡æ²¡æœ‰è¿‡æœŸ, ä½†ä¸€å¸§å·²ç»æ— å¯ç”¨æ—¶é—´ æˆ– éœ€è¦è¢«ä¸­æ–­, åˆ™è®©å‡ºä¸»çº¿ç¨‹

            // æ¯ä¸€æ¬¡æ‰§è¡Œå‡è¿›è¡Œè¶…æ—¶æ£€æµ‹ï¼Œåšåˆ°è®©å‡ºä¸»çº¿ç¨‹ã€‚

            if (currentTask.expirationTime &gt; currentTime

 &amp;&amp; (!hasTimeRemaining || shouldYieldToHost())) {

 break

 }

            // æ‰§è¡Œä»»åŠ¡

            const callback = currentTask.callback;

            const continuationCallback = callback(didUserCallbackTimeout);

            // å¦‚æœè¯¥ä»»åŠ¡å, è¿˜æœ‰è¿ç»­å›è°ƒ

            if (typeof continuationCallback === 'function') {

                // åˆ™ä¿ç•™å½“å‰

                currentTask.callback = continuationCallback;

            } else  {

                // å°†currentTaskç§»é™¤è¯¥é˜Ÿåˆ—

                pop(taskQueue);

            }


            // æ›´æ–°currentTask

            currentTask = peek(taskQueue);

        }

    },

}
</code></pre></div><p>ç®€è€Œè¨€ä¹‹:</p> <ol><li><p>æœ‰ä¸ªä»»åŠ¡é˜Ÿåˆ— queueï¼Œè¯¥é˜Ÿåˆ—å­˜æ”¾å¯ä¸­æ–­çš„ä»»åŠ¡ã€‚</p></li> <li><p><code>workLoop</code>å¯¹é˜Ÿåˆ—é‡Œå–ç¬¬ä¸€ä¸ªä»»åŠ¡currentTaskï¼Œè¿›å…¥å¾ªç¯å¼€å§‹æ‰§è¡Œã€‚</p></li> <li><ul><li>å¦‚æœä»»åŠ¡æ‰§è¡Œå®Œåï¼Œè¿˜æœ‰è¿ç»­çš„å›è°ƒï¼Œåˆ™ currentTask.callback = continuationCallback</li> <li>å¦åˆ™ç§»é™¤å·²å®Œæˆçš„ä»»åŠ¡</li> <li>å½“è¯¥ä»»åŠ¡æ²¡æœ‰æ—¶é—´ æˆ– éœ€è¦ä¸­æ–­ (æ¸²æŸ“ä»»åŠ¡ æˆ– å…¶ä»–é«˜ä¼˜ä»»åŠ¡æ’å…¥ç­‰)ï¼Œåˆ™è®©å‡ºä¸»çº¿ç¨‹ã€‚</li> <li>å¦åˆ™æ‰§è¡Œä»»åŠ¡ currentTask.callback()</li> <li>æ›´æ–°ä»»åŠ¡currentTaskï¼Œç»§ç»­å¾ªç¯èµ°èµ·ã€‚</li></ul></li></ol> <p>è¿™é‡Œè¿˜æ¶‰åŠæ›´å¤šç»†èŠ‚ï¼Œä¾‹å¦‚:</p> <ul><li>requestAnimationFrame è®¡ç®—ä¸€å¸§çš„ç©ºä½™æ—¶é—´ï¼›</li> <li>ä½¿ç”¨new MessageChannel () æ‰§è¡Œå®ä»»åŠ¡;</li> <li>ä¼˜å…ˆçº§;</li> <li>...</li></ul> <p>è¿™é‡Œä¸åšè¯¦ç»†è¯´æ˜ã€‚</p> <h2 id="_8-å°æ€»ç»“"><a href="#_8-å°æ€»ç»“" class="header-anchor">#</a> 8.å°æ€»ç»“</h2> <ul><li>æˆ‘ä»¬æƒ³è¦å®ç°<strong>å¹¶å‘</strong>è¯‰æ±‚ï¼Œå°±éœ€è¦ä»åº•å±‚é‡æ„ï¼Œå³<strong>FiberNode</strong>çš„å®ç°ã€‚</li> <li>è°ƒç”¨æ ˆcall stackæ˜¯æ— æ³•åšåˆ°å¹¶å‘ (å¼‚æ­¥å¯ä¸­æ–­) è¯‰æ±‚ï¼Œæ•…Reactè‡ªè¡Œå®ç°äº†ä¸€å¥—<strong>è™šæ‹Ÿæ ˆå¸§ã€‚</strong></li> <li><strong>è™šæ‹Ÿæ ˆå¸§</strong> æ˜¯è¦å…·å¤‡<strong>è°ƒåº¦</strong>èƒ½åŠ›çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•åœ¨é€‚å½“çš„æ—¶å€™å»æ‰§è¡Œä»»åŠ¡ã€‚</li> <li><strong>scheduler</strong> å¯åšåˆ°å¼‚æ­¥å¯ä¸­æ–­ï¼Œå¹¶å¯è‡ªä¸»åˆ†é…ä¼˜å…ˆçº§é«˜ä½çš„ä»»åŠ¡ã€‚</li></ul> <p>(å³ä»»åŠ¡ (çŠ¶æ€: è¿è¡Œ/ä¸­æ–­/ç»§ç»­) <strong>Lane</strong>è¿è¡Œç­–ç•¥)</p> <p>(å®é™…ä¸Šï¼Œscheduler + Lane è°ƒåº¦ç­–ç•¥è¿œæ¯”è¯¥å¤„ç†å¤æ‚çš„å¤šğŸ˜­)</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>å›¾: å‰åå¯¹æ¯” (ä¸ªäººç†è§£, é”™è¯¯è¯·æŒ‡æ­£)</p> <p>ä»¥ä¸Šï¼ŒåŒå­¦ä»¬æ˜¯ä¸æ˜¯å¯¹React Fiberæ¶æ„æœ‰äº†åˆæ­¥çš„ç†è§£å“¦~</p> <h1 id="å…¶ä»–è¯´æ˜"><a href="#å…¶ä»–è¯´æ˜" class="header-anchor">#</a> å…¶ä»–è¯´æ˜</h1> <h3 id="åŒç¼“å­˜æœºåˆ¶"><a href="#åŒç¼“å­˜æœºåˆ¶" class="header-anchor">#</a> åŒç¼“å­˜æœºåˆ¶</h3> <blockquote><p>å‚è€ƒ: <strong>åŒç¼“å­˜Fiberæ ‘</strong>[22]</p></blockquote> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>è‡³å¤šæœ‰ä¸¤æ£µ Fiber Treeã€‚</p> <p>åˆ†åˆ«å«åšcurrent fiber tree å’Œ workInProgress fiber treeã€‚</p> <p>å³åœ¨å±å¹•ä¸Šå·²å»ºç«‹çš„fiber tree å’Œ å› ä¸ºæ•°æ®å˜åŒ–é‡æ–°åœ¨å†…å­˜é‡Œåˆ›å»ºçš„fiber treeã€‚</p> <p>ä»–ä»¬ä¹‹é—´æ˜¯é€šè¿‡ alternateå±æ€§(æŒ‡é’ˆ) å»ºç«‹è¿æ¥ã€‚</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <p>ç®€å•çš„è¯´:</p> <ol><li>å°±æ˜¯workInProgress fiberçš„åˆ›å»º <strong>æ˜¯å¦å¯å¤ç”¨</strong> current fiberçš„èŠ‚ç‚¹ã€‚åç»­å¯å†è¯¦çœ‹diffç®—æ³•ã€‚</li> <li>workInProgress fiber tree å°†ç¡®å®šè¦å˜æ›´èŠ‚ç‚¹ï¼Œæ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚</li> <li>workInProgress fiber tree æ™‹å‡ä¸º current fiber treeã€‚</li></ol> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="å›¾ç‰‡"></p> <h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h3> <p>[1]ä»å†…éƒ¨äº†è§£ç°ä»£æµè§ˆå™¨(3): <em>https://juejin.cn/post/6844903687383416840</em>[2]æ¸²æŸ“æ ‘æ„å»ºã€å¸ƒå±€åŠç»˜åˆ¶: <em>https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction</em>[3]RequestIdleCallback å®éªŒ: <em>https://github.com/Linjiayu6/FE-RequestIdleCallback-demo</em>[4]RequestIdleCallback: <em>https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback</em>[5]RequestIdleCallback: <em>https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback</em>[6]RequestIdleCallback å®éªŒ: <em>https://github.com/Linjiayu6/FE-RequestIdleCallback-demo</em>[7]React: stack reconcilerå®ç°: <em>https://zh-hans.reactjs.org/docs/implementation-notes.html</em>[8]React ç®—æ³•ä¹‹æ·±åº¦ä¼˜å…ˆéå†: <em>https://juejin.cn/post/6912280245055782920</em>[9]è°ƒç”¨æ ˆ: <em>https://segmentfault.com/a/1190000010360316</em>[10]Leetcode: æ–æ³¢æ‹‰å¥‘æ•°åˆ—: <em>https://leetcode-cn.com/problems/fei-bo-na-qi-shu-lie-lcof/</em>[11]Leetcode: 70. çˆ¬æ¥¼æ¢¯: <em>https://leetcode-cn.com/problems/climbing-stairs/</em>[12]ReactFiberWorkLoop.old.js: <em>https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1558</em>[13]program: <em>https://en.wikipedia.org/wiki/Computer_program</em>[14]algorithm: <em>https://en.wikipedia.org/wiki/Algorithm</em>[15]problem: <em>https://en.wikipedia.org/wiki/Problem_solving</em>[16]partial order: <em>https://en.wikipedia.org/wiki/Partial_Order</em>[17]Call Stack: <em>https://segmentfault.com/a/1190000021456103</em>[18]FiberNode.js: <em>https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiber.new.js#L117</em>[19]beginWork(): <em>https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3058</em>[20]completeWork(): <em>https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L652</em>[21]workloop.js: <em>https://github.com/facebook/react/blob/v17.0.1/packages/scheduler/src/Scheduler.js#L164</em>[22]åŒç¼“å­˜Fiberæ ‘: <em>https://react.iamkasong.com/process/doubleBuffer.html#update%E6%97%B6</em></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">5/24/2022, 11:56:22 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/fiber/" class="prev router-link-active">
        Fiber
      </a></span> <span class="next"><a href="/fiber/ReactFiberæ˜¯å¦‚ä½•å®ç°æ›´æ–°è¿‡ç¨‹å¯æ§çš„.html">
        React Fiber æ˜¯å¦‚ä½•å®ç°æ›´æ–°è¿‡ç¨‹å¯æ§çš„
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.c06c5691.js" defer></script><script src="/assets/js/2.e21ead49.js" defer></script><script src="/assets/js/28.4837174d.js" defer></script>
  </body>
</html>
