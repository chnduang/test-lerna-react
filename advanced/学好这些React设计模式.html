<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>学好这些React设计模式-能让你的 React 项目飞起来 | duangdong的react</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="react相关知识归纳总结">
    <meta name="keywords" content="react,react进阶,react性能优化,react-hooks,react源码">
    
    <link rel="preload" href="/assets/css/0.styles.a427ee9b.css" as="style"><link rel="preload" href="/assets/js/app.c06c5691.js" as="script"><link rel="preload" href="/assets/js/2.e21ead49.js" as="script"><link rel="preload" href="/assets/js/24.a72c373a.js" as="script"><link rel="prefetch" href="/assets/js/10.b9a4c71a.js"><link rel="prefetch" href="/assets/js/11.f55d2255.js"><link rel="prefetch" href="/assets/js/12.fe15bcdc.js"><link rel="prefetch" href="/assets/js/13.87a3c5ce.js"><link rel="prefetch" href="/assets/js/14.ebf89fa4.js"><link rel="prefetch" href="/assets/js/15.cda0a8ba.js"><link rel="prefetch" href="/assets/js/16.f9dc23dc.js"><link rel="prefetch" href="/assets/js/17.84340ca0.js"><link rel="prefetch" href="/assets/js/18.bd273a95.js"><link rel="prefetch" href="/assets/js/19.81155919.js"><link rel="prefetch" href="/assets/js/20.9fd76e46.js"><link rel="prefetch" href="/assets/js/21.ace06104.js"><link rel="prefetch" href="/assets/js/22.90ade980.js"><link rel="prefetch" href="/assets/js/23.0666abd7.js"><link rel="prefetch" href="/assets/js/25.b969cb94.js"><link rel="prefetch" href="/assets/js/26.de056b27.js"><link rel="prefetch" href="/assets/js/27.c42084cb.js"><link rel="prefetch" href="/assets/js/28.4837174d.js"><link rel="prefetch" href="/assets/js/29.ff25f8d5.js"><link rel="prefetch" href="/assets/js/3.860eacbd.js"><link rel="prefetch" href="/assets/js/30.713760c5.js"><link rel="prefetch" href="/assets/js/31.7c617c61.js"><link rel="prefetch" href="/assets/js/32.d175bcfe.js"><link rel="prefetch" href="/assets/js/33.74590403.js"><link rel="prefetch" href="/assets/js/34.83533364.js"><link rel="prefetch" href="/assets/js/35.074e3e13.js"><link rel="prefetch" href="/assets/js/36.1ccfc83b.js"><link rel="prefetch" href="/assets/js/37.a396d472.js"><link rel="prefetch" href="/assets/js/38.db4bd748.js"><link rel="prefetch" href="/assets/js/39.df82dded.js"><link rel="prefetch" href="/assets/js/4.8f6f0475.js"><link rel="prefetch" href="/assets/js/40.c748e8b5.js"><link rel="prefetch" href="/assets/js/5.8b87f02a.js"><link rel="prefetch" href="/assets/js/6.2f86309f.js"><link rel="prefetch" href="/assets/js/7.f1cc41de.js"><link rel="prefetch" href="/assets/js/8.9c653580.js"><link rel="prefetch" href="/assets/js/9.af331656.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427ee9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdong的react</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fiber/" class="nav-link">
  Fiber
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  进阶
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fiber/" class="nav-link">
  Fiber
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  进阶
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/advanced/" aria-current="page" class="sidebar-link">进阶</a></li><li><a href="/advanced/Render如何强制它.html" class="sidebar-link">什么是 React 中的 Render 以及如何强制它？</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>hoc</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>keys</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/advanced/react-svelte入门.html" class="sidebar-link">写给 React 开发者看的 Svelte入门</a></li><li><a href="/advanced/react16常见api以及原理剖析.html" class="sidebar-link">react16常见api以及原理剖析</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>setstate</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/advanced/五分钟带你掌握优先队列.html" class="sidebar-link">五分钟带你掌握优先队列</a></li><li><a href="/advanced/前端架构之React领域驱动设计.html" class="sidebar-link">前端架构之 React 领域驱动设计</a></li><li><a href="/advanced/学好这些React设计模式.html" class="active sidebar-link">学好这些React设计模式-能让你的 React 项目飞起来</a></li><li><a href="/advanced/浅谈React中的XSS攻击.html" class="sidebar-link">浅谈 React 中的 XSS 攻击</a></li><li><a href="/advanced/错误边界.html" class="sidebar-link">错误边界（Error Boundaries）</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="学好这些react设计模式-能让你的-react-项目飞起来"><a href="#学好这些react设计模式-能让你的-react-项目飞起来" class="header-anchor">#</a> 学好这些React设计模式-能让你的 React 项目飞起来</h1> <blockquote><p><a href="https://mp.weixin.qq.com/s/dfnajqS0NqTkp7fzK4-4Sw" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/dfnajqS0NqTkp7fzK4-4Sw<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="一-前言"><a href="#一-前言" class="header-anchor">#</a> 一 前言</h2> <p>今天我们来悉数一下 React 中一些不错的设计模式，这些设计模式能够解决一些<strong>功能复杂</strong>，<strong>逻辑复用</strong> 的问题，还能锻炼开发者的设计和编程能力，以为多年开发经验来看，学好这些设计模式，那就是一个字 <strong>香</strong>！</p> <p>基本上每一个设计模式，笔者都会绞尽脑汁的想出两个 demo，希望屏幕前的你能给笔者赏个<strong>赞</strong>，以此鼓励我继续创作前端硬文。</p> <p>老规矩，我们带着疑问开始今天的阅读：</p> <ul><li>1 React 的常见设计模式有哪些？</li> <li>2 组合模式功能强大，都用于哪些场景。</li> <li>3 render props 使用，开发者应该注意些什么？</li> <li>4 hoc 模式的应用场景。</li> <li>5 提供者模式实现状态管理和状态下发。</li> <li>6 如何使用继承模式，继承模式的优缺点是什么？</li></ul> <p>我相信读完这篇文章，这些问题全都会迎刃而解。</p> <p>首先我们想一个问题，那就是 <strong>为什么要学习设计模式？</strong> 原因我总结有以下几个方面。</p> <ul><li>**1 功能复杂，逻辑复用问题。**首先 React 灵活多变性，就决定了 React 项目可以应用多种设计模式。但是这些设计模式的产生也确实办了实事:</li></ul> <p><strong>场景一：</strong></p> <p>在一个项目中，全局有一个状态，可以称之为 theme （主题），那么有很多 UI 功能组件需要这个主题，而且这个主题是可以切换的，就像 github 切换暗黑模式一样，那么如何优雅的实现这个功能呢？</p> <p>这个场景如果我们用 React 的<strong>提供者模式</strong>，就能轻松搞定了，通过 <code>context</code> 保存全局的主题，然后将 <code>theme</code> 通过 <code>Provider</code> 形式传递下去，需要 theme ，那么消费 context ，就可以了，这样的好处是，只要 theme 改变，消费 context 的组件就会重新更新，达到了切换主题的目的。</p> <p><strong>场景二：</strong></p> <p>表单设计场景也需要一定程度上的 React 的设计模式，首先对于表单状态的整体验证需要外层的 <code>Form</code> 绑定事件控制，调度表单的状态下发，验证功能。内层对于每一个表单控件还需要 <code>FormItem</code> 收集数据，让控件变成受控的。这样的 <code>Form</code> 和 <code>FormItem</code> 方式，就是通过<strong>组合模式</strong>实现的。</p> <ul><li><strong>2 培养设计能力，编程能力</strong></li></ul> <p>熟练运用 React 的设计模式，可以培养开发者的设计能力，比如 <strong><code>HOC</code> 的设计</strong> ，<strong>公共组件的设计</strong> ，<strong>自定义 hooks 的设计</strong>，一些开源的优秀的库就是通过 React 的灵活性和优秀的设计模式实现的。</p> <p><strong>例子一：</strong></p> <p>比如在 React 状态管理工具中，无论是 <code>react-redux</code> ，还是 <code>mobx-react</code>，一方面想要把 <code>state</code> 和 <code>dispatch</code> 函数传递给组件，另一方面订阅 state 变化，来促使业务组件更新，那么整个流程中，需要一个或多个 HOC 来搞定。于是 react-redux 提供了 <code>connect</code>，mobx-react 提供了 <code>inject</code> ，<code>observer</code> 等优秀的 hoc。由此可见，学会 React 的设计模式，有助于开发者小到编写公共组件，大到开发开源项目。</p> <p>今天我重点介绍 React 的五种设计模式，分别是：</p> <ul><li>组合模式</li> <li>render props模式</li> <li>hoc 模式</li> <li>提供者模式</li> <li>类组件继承</li></ul> <h2 id="二-组合模式"><a href="#二-组合模式" class="header-anchor">#</a> 二 组合模式</h2> <h3 id="_1-介绍"><a href="#_1-介绍" class="header-anchor">#</a> 1 介绍</h3> <p>组合模式适合一些容器组件场景，通过外层组件包裹内层组件，这种方式在 Vue 中称为 slot 插槽，外层组件可以轻松的获取内层组件的 <code>props</code> 状态，还可以控制内层组件的渲染，组合模式能够直观反映出 父 -&gt; 子组件的包含关系，首先我来举个最简单的组合模式例子🌰。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tabs</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>  <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TabItem</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>react<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>react<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">React</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">TabItem</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TabItem</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vue<span class="token punctuation">&quot;</span></span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vue<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">Vue</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">TabItem</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TabItem</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>angular<span class="token punctuation">&quot;</span></span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>angular<span class="token punctuation">&quot;</span></span>  <span class="token punctuation">&gt;</span></span><span class="token plain-text">Angular</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">TabItem</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tabs</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如上 <code>Tabs</code> 和 <code>TabItem</code> 组合，构成切换 tab 功能，那么 Tabs 和 TabItem 的分工如下：</p> <ul><li>Tabs 负责展示和控制对应的 TabItem 。绑定切换 tab 回调方法 onChange。当 tab 切换的时候，执行回调。</li> <li>TabItem 负责展示对应的 tab 项，向 Tabs 传递 props 相关信息。</li></ul> <p>我们直观上看到 Tabs 和 TabItem 并没有做某种关联，但是却无形的联系起来。这种就是组合模式的精髓所在，这种组合模式的组件，给使用者感觉很舒服，因为大部分工作，都在开发组合组件的时候处理了。所以编写组合模式的嵌套组件，对锻炼开发者的 React 组件封装能力是很有帮助的。</p> <p>接下来我们一起看一下，组合模式内部是如何实现的。</p> <h3 id="_2-原理揭秘"><a href="#_2-原理揭秘" class="header-anchor">#</a> 2 原理揭秘</h3> <p>实际组合模式的实现并没有想象中那么复杂，主要分为外层和内层两部分，当然可能也存在多层组合嵌套的情况，但是万变不离其宗，原理都是一样的。首先我们看一个简单的组合结构：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span>  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《React进阶实践指南》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="那么-groups-能对-item-做一些什么操作呢"><a href="#那么-groups-能对-item-做一些什么操作呢" class="header-anchor">#</a> 那么 <code>Groups</code> 能对 <code>Item</code> 做一些什么操作呢 ？</h4> <p><strong>Item 在 Groups的形态</strong></p> <p>首先如果如上组合模式的写法，会被 <code>jsx</code> 编译成 <code>React element</code> 形态，<code>Item</code> 可以通过 <code>Groups</code> 的  <strong>props.children</strong> 访问到。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>children  <span class="token punctuation">)</span> <span class="token comment">// Groups element</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>children<span class="token punctuation">.</span>props <span class="token punctuation">)</span> <span class="token comment">// { name : 'React进阶实践指南》' }</span>
    <span class="token keyword">return</span>  props<span class="token punctuation">.</span>children
<span class="token punctuation">}</span>
</code></pre></div><p>但是这是针对单一节点的情况，事实情况下，外层容器可能有多个子组件的情况。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span>  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《React进阶实践指南》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《Nodejs深度学习手册》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这种情况下，props.children 就是一个数组结构，如果想要访问每一个的 props ，那么需要通过 <code>React.Children.forEach</code> 遍历 props.children。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>children  <span class="token punctuation">)</span> <span class="token comment">// Groups element</span>
    React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span><span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> item<span class="token punctuation">.</span>props <span class="token punctuation">)</span>  <span class="token comment">//依次打印 props</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  props<span class="token punctuation">.</span>children
<span class="token punctuation">}</span>
</code></pre></div><p><strong>隐式混入 props</strong></p> <p>这个是组合模式的精髓所在，就是可以通过 React.cloneElement 向 children 中混入其他的 props，那么子组件就可以使用容器父组件提供的<strong>特有的</strong> props 。我们来看一下具体实现：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Item</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token comment">// {name: &quot;《React进阶实践指南》&quot;, author: &quot;alien&quot;}</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> 名称： </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChilren <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span><span class="token punctuation">{</span> <span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">'alien'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  newChilren
<span class="token punctuation">}</span>
</code></pre></div><ul><li>用 <code>React.cloneElement</code> 创建一个新的 element，然后混入其他的 props -&gt; author 属性，React.cloneElement 的第二个参数，会和之前的 props 进行合并 （ merge ）。</li></ul> <p>这里还是 Groups 只有单一节点的情况，有些同学会问直接在原来的 children 基础上加入新属性不就可以了吗？像如下这样：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span>props<span class="token punctuation">.</span>author <span class="token operator">=</span> <span class="token string">'alien'</span>
</code></pre></div><ul><li>这样会报错，对于 props ，React 会进行保护，我们无法对 props 进行拓展。所以要想隐式混入 props ，只能通过 <code>cloneElement</code> 来实现。</li></ul> <p><strong>控制渲染</strong></p> <p>组合模式可以通过 children 方式获取内层组件，也可以根据内层组件的状态来控制其渲染。比如如下的情况：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span>  <span class="token attr-name">isShow</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《React进阶实践指南》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span>  <span class="token attr-name">isShow</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《Nodejs深度学习手册》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">hello,world</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>如上这种情况组合模式，只渲染 <code>isShow = true</code> 的 Item 组件。那么外层组件是如何处理的呢？</li></ul> <p>实际处理这个很简单，也是通过遍历 children ，然后通过对比 props ，选择需要渲染的 children 。接下来一起看一下如何控制：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Item</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> 名称： </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
<span class="token comment">/* Groups 组件 */</span>
<span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">,</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> item <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> Item <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>isShow  <span class="token punctuation">)</span><span class="token punctuation">{</span>
            newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  newChildren
<span class="token punctuation">}</span>
</code></pre></div><ul><li>通过 <code>newChildren</code> 存放满足要求的 React Element ，通过 <code>Children.forEach</code> 遍历 children 。</li> <li>通过 <code>isValidElement</code> 排除非 element 节点；<code>type</code>指向 <code>Item</code>函数内存，排除非 Item 元素；获取 isShow 属性，只展示 isShow = true 的 <code>Item</code>，最终效果满足要求。</li></ul> <p><strong>内外层通信</strong></p> <p>组合模式可以轻松的实现内外层通信的场景，原理就是通过外层组件，向内层组件传递回调函数 <code>callback</code> ，内层通过调用 <code>callback</code> 来实现两层组合模式的通信关系。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Item</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        名称：</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> props<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'let us learn React!'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">点击</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' children 内容：'</span><span class="token punctuation">,</span>val <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>children <span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">callback</span><span class="token operator">:</span>handleCallback <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>Groups</code> 向 <code>Item</code> 组件中隐式传入回调函数 <code>callback</code>，将作为新的 props 传递。</li> <li><code>Item</code> 可以通过调用 <code>callback</code> 向 <code>Groups</code>传递信息。实现了内外层的通信。</li></ul> <p><strong>复杂的组合场景</strong></p> <p>组合模式还有一种场景，在外层容器中，进行再次组合，这样组件就会一层一层的包裹，一次又一次的强化。这里举一个例子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Item</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        名称：</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        作者：</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">}</span><span class="token plain-text">   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        对大家说：</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>mes<span class="token punctuation">}</span><span class="token plain-text">   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
<span class="token comment">/* 第二层组合 -&gt; 混入 mes 属性  */</span>
<span class="token keyword">function</span> <span class="token function">Wrap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>children<span class="token punctuation">,</span><span class="token punctuation">{</span> <span class="token literal-property property">mes</span><span class="token operator">:</span><span class="token string">'let us learn React!'</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 第一层组合，里面进行第二次组合，混入 author 属性  */</span>
<span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Wrap</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">'alien'</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Wrap</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《React进阶实践指南》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在 <code>Groups</code> 组件里通过 <code>Wrap</code> 再进行组合。经过两次组合，把 <code>author</code> 和 <code>mes</code> 混入到 props 中。</li></ul> <p>这种组合模式能够一层层强化原始组件，外层组件不用过多关心内层到底做了些什么? 只需要处理 <code>children</code> 就可以，同样内层 <code>children</code>在接受业务层的<code>props</code>外，还能使用来自外层容器组件的<strong>状态</strong>，<strong>方法</strong>等。</p> <h3 id="_3-注意细节"><a href="#_3-注意细节" class="header-anchor">#</a> 3 注意细节</h3> <p>组合模式也有很多细节值得注意，首先最应该想到的就是对于 <code>children</code> 的类型校验，因为组合模式，外层容器组件对 <code>children</code> 的属性状态是未知的。如果在不确定 <code>children</code> 的状态下，如果直接挂载，就会出现报错等情况。所以验证 children 的合法性就显得非常重要。</p> <p><strong>验证children</strong></p> <p>比如如下，本质上形态是属于 render props 形式。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
   </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span>  <span class="token attr-name">isShow</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《React进阶实践指南》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
&lt;/</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><p>上面的情况，如果 Groups 直接用 children 挂载的话。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span>children
<span class="token punctuation">}</span>
</code></pre></div><p>这样的情况，就会报 <code>Functions are not valid as a React child</code> 的错误。那么需要在 Groups 做判断，我们来一起看一下：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  React<span class="token punctuation">.</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
     <span class="token operator">?</span> props<span class="token punctuation">.</span>children
     <span class="token operator">:</span> <span class="token keyword">typeof</span> props<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span>
       props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>首先判断 children 是否是 React.element ，如果是那么直接渲染，如果不是，那么接下来判断是否是函数，如果是函数，那么直接函数，如果不是那么直接渲染 <code>null</code> 就可以了。</li></ul> <p><strong>绑定静态属性</strong></p> <p>现在还有一个暴露的问题是，外层组件和内层组件通过什么识别身份呢？比如如下的场景：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span>  <span class="token attr-name">isShow</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>《React进阶实践指南》<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Text</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Groups</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span></code></pre></div><p>如下，<code>Groups</code> 内部有两个组件，一个是 <code>Item</code> ，一个是 <code>Text</code> ，但是只有 <code>Item</code> 是有用的，那么如何证明 Item 组件呢。那么我们需要给组件函数或者类绑定静态属性，这里可以统一用 <strong><code>displayName</code></strong> 来标记组件的身份。</p> <p>那么只需要这么做就可以了：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
Item<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token string">'Item'</span>
</code></pre></div><p>那么在 Groups 中就可以找到对应的 Item 组件，排除 Text 组件。具体可以通过 children 上的 <code>type</code> 属性找到对应的函数或者是类，然后判断 type 上的 displayName 属性找到对应的 Item 组件，<strong>本质上 displayName 主要用于调试，这里要记住组合方式，可以使用子组件的静态属性就可以了。</strong> 当然也可以通过内存空间相同的方式。</p> <p>具体参考方式：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Groups</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">,</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> item <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>displayName <span class="token operator">===</span> <span class="token string">'Item'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  newChildren
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>displayName</code>属性找到 <code>Item</code>。</p> <h3 id="_4-实践demo"><a href="#_4-实践demo" class="header-anchor">#</a> 4 实践demo</h3> <p>接下来，我们来简单实现刚开始的 <code>tab</code>，<code>tabItem</code> 切换功能。</p> <p><strong>tab实现</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> <span class="token function-variable function">Tab</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">,</span>onChange <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> activeIndex <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span>forceUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 提供给 tab 使用  */</span>
    <span class="token keyword">const</span> tabList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">/* 待渲染组件 */</span>
    <span class="token keyword">let</span> renderChildren <span class="token operator">=</span> <span class="token keyword">null</span>
    React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">/* 验证是否是 &lt;TabItem&gt; 组件  */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>type<span class="token punctuation">.</span>displayName <span class="token operator">===</span> <span class="token string">'tabItem'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> item
            <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> label <span class="token punctuation">}</span> <span class="token operator">=</span> props
            <span class="token keyword">const</span> tabItem <span class="token operator">=</span> <span class="token punctuation">{</span>
                name<span class="token punctuation">,</span>
                label<span class="token punctuation">,</span>
                <span class="token literal-property property">active</span><span class="token operator">:</span> name <span class="token operator">===</span> activeIndex<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
                <span class="token literal-property property">component</span><span class="token operator">:</span> item
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>name <span class="token operator">===</span> activeIndex<span class="token punctuation">.</span>current<span class="token punctuation">)</span> renderChildren <span class="token operator">=</span> item
            tabList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tabItem<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 第一次加载，或者 prop children 改变的情况 */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>renderChildren <span class="token operator">&amp;&amp;</span> tabList<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> fisrtChildren <span class="token operator">=</span> tabList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        renderChildren <span class="token operator">=</span> fisrtChildren<span class="token punctuation">.</span>component
        activeIndex<span class="token punctuation">.</span>current <span class="token operator">=</span> fisrtChildren<span class="token punctuation">.</span>component<span class="token punctuation">.</span>props<span class="token punctuation">.</span>name
        fisrtChildren<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 切换tab */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">changeTab</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        activeIndex<span class="token punctuation">.</span>current <span class="token operator">=</span> name
        <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        onChange <span class="token operator">&amp;&amp;</span> <span class="token function">onChange</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header<span class="token punctuation">&quot;</span></span>   <span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>
                tabList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tab<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_item<span class="token punctuation">&quot;</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span>  <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">changeTab</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
                        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">'text'</span><span class="token punctuation">}</span></span>  <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>tab<span class="token punctuation">.</span>label<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                        </span><span class="token punctuation">{</span>tab<span class="token punctuation">.</span>active <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>active_bored<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
                    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>renderChildren<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

Tab<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token string">'tab'</span> 
</code></pre></div><p>我写的这个 Tab，负责了整个 Tab 切换的主要功能，包括 <strong>TabItem 的过滤</strong>，<strong>状态收集</strong>，<strong>控制对应的子组件展示</strong>。</p> <ul><li>首先通过 <code>Children.forEach</code> 找到符合条件的 <code>TabItem</code>。收集 <code>TabItem</code>的 props，形成菜单结构。</li> <li>找到对应的 <code>children</code> ，渲染正确的 children 。</li> <li>提供改变 tab 的方法 <code>changeTab</code>。</li> <li>displayName 标记 <code>Tab</code> 组件。这个主要目的方便调试。</li></ul> <p><strong>TabItem 的实现</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const TabItem = ({ children }) =&gt; {
    return &lt;div&gt;{children}&lt;/div&gt;
}
TabItem.displayName = 'tabItem'
</code></pre></div><p>这个 demo 中的 TabItem 功能十分简单，大部分事情都交给 Tab 做了。</p> <p>TabItem 做的事情是：</p> <ul><li>展示 <code>children</code> （ 我们写在 TabItem 里面的内容 ）</li> <li>绑定静态属性 <code>displayName</code> 。</li></ul> <p><strong>效果</strong></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_gif/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQSlK3cxpkDSgtTMGlS2icIrRZUibhGLPJKvGQI6taaNn2lqiclT9HCfJQQ/640?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="图片"></p> <h3 id="_5-总结"><a href="#_5-总结" class="header-anchor">#</a> 5 总结</h3> <p>组合模式在日常开发中，用途还是比较广泛的，尤其是在一些比较出色的开源项目中，组合模式的总结内容如下：</p> <ul><li>组合模式通过外层组件获取内层组件 children ，通过 cloneElement 传入新的状态，或者控制内层组件渲染。</li> <li>组合模式还可以和其他组件组合，或者是 render props，拓展性很强，实现的功能强大。</li></ul> <p>总结流程图如下：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQa2Fe53890uoLm5icCjtEnvBEDFHFCgIXec2GEAy6eOheIs37nmTaa7w/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="三-render-props模式"><a href="#三-render-props模式" class="header-anchor">#</a> 三 render props模式</h2> <blockquote><p><a href="https://cdb.reacttraining.com/use-a-render-prop-50de598f11ce" target="_blank" rel="noopener noreferrer"><em>任何</em>被用于告知组件需要渲染什么内容的函数 prop 在技术上都可以被称为 “render prop”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <h3 id="_1-介绍-2"><a href="#_1-介绍-2" class="header-anchor">#</a> 1 介绍</h3> <p><code>render props</code> 模式和组合模式类似。区别不同的是，用函数的形式代替 <code>children</code>。函数的参数，由容器组件提供，这样的好处，将容器组件的状态，提升到当前外层组件中，这个是一个巧妙之处，也是和组合模式相比最大的区别。</p> <p>我们先来看一下一个基本的 <code>render props</code> 长什么样子：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> aProps <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'《React进阶实践指南》'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">cProps</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Children</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>cProps<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span> <span class="token operator">...</span>aProps <span class="token punctuation">}</span></span>  <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上是 <code>render props</code> 的基本样子。可以清楚的看到：</p> <ul><li><code>cProps</code> 为 <code>Container</code> 组件提供的状态。</li> <li><code>aProps</code> 为 <code>App</code> 提供的状态。这种模式优点是，能够给<code>App</code> 的子组件 <code>Container</code> 的状态提升到 <code>App</code> 的 <code>render</code> 函数中。然后可以组合成新的<code>props</code>，传递给 <code>Children</code>，这种方式让容器化的感念更显而易见。</li></ul> <p>接下来我们研究一下<code>render props</code> 原理和细节。</p> <h3 id="_2-原理和细节"><a href="#_2-原理和细节" class="header-anchor">#</a> 2 原理和细节</h3> <p>首先一个问题是<code>render props</code> 这种方式到底适合什么场景，实际这种模式更适合一种，容器包装，状态的获取。可能这么说有的同学不明白。那么一起看一下 <code>context</code> 中的 <code>Consumer</code>。就采用 <code>render props</code> 模式。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> Context <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Context.Consumer</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
           </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">contextValue</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
               名称：</span><span class="token punctuation">{</span>contextValue<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text">
               作者：</span><span class="token punctuation">{</span>contextValue<span class="token punctuation">.</span>author<span class="token punctuation">}</span><span class="token plain-text">
           </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Context.Consumer</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'《React进阶实践指南》'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">'我不是外星人'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Context.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Context.Provider</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>我们看到<code>Consumer</code> 就是一个容器组件，包装即将渲染的内容，然后通过 <code>children render</code> 函数执行把状态 <code>contextValue</code> 从下游向上游提取。</li></ul> <p>那么接下来模拟一下 <code>Consumer</code> 的内部实现。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">myConsumer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> contextValue <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>Context<span class="token punctuation">)</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span>contextValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上就模拟了一个 Consumer 功能，从 Consumer 的实现看 render props 本质就是容器组件产生状态，再通过 children 函数传递下去。所以这种模式我们应该更在乎的是，<strong>容器组件能提供些什么？</strong></p> <p><strong>派生新状态</strong></p> <p>相比传统的组合模式，render props 还有一个就是灵活性，可以通过容器组件的状态和当前组件的状态结合，派生出新的状态。比如如下</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">cProps</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span>  <span class="token keyword">const</span> nProps <span class="token operator">=</span>  <span class="token function">getNewProps</span><span class="token punctuation">(</span> aProps <span class="token punctuation">,</span> cProps <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Children</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>nProps<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain-text">
 </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>nProps</code> 是通过当前组件的状态 <code>aProps</code> 和 <code>Container</code> 容器组件 <code>cProps</code> ，合并计算得到的状态。</li></ul> <p><strong>反向状态回传</strong></p> <p>这种情况比较极端，笔者也用过这种方法，就是可以通过 <code>render props</code> 中的状态，提升到当前组件中，也就是把容器组件内的状态，传递给父组件。比如如下情况。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">GetContanier</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> dom <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">getDom</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  dom<span class="token punctuation">.</span>current
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>dom<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span> getDom <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token comment">/* 保存 render props 回传的状态 */</span>
     <span class="token keyword">const</span> getChildren <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
     <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> childDom <span class="token operator">=</span> getChildren<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> childDom<span class="token punctuation">,</span><span class="token string">'childDom'</span> <span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">GetContanier</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>getDom<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            getChildren<span class="token punctuation">.</span>current <span class="token operator">=</span> getDom
            <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">GetContanier</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQoc1nrHXPsf7L53w9lHW6eKGB2ialunRd4ianQpRvntTBDSPqBicuw54Ng/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <ul><li>这是一个复杂的状态回传的场景，在 <code>GetContanier</code> 将获取元素的方法 <code>getDom</code> 通过 <code>render props</code> 回传给父组件。</li> <li>父组件 App 通过 <code>getChildren</code> 保存 <code>render props</code> 回传的内容，在 <code>useEffect</code> 调用 <code>getDom</code> 方法，打印内容如下：</li></ul> <p>但是现实情况不可能是获取一个 <code>dom</code> 这么简单，真实情景下，回传的内容可能更加复杂。</p> <h3 id="_3-注意问题"><a href="#_3-注意问题" class="header-anchor">#</a> 3 注意问题</h3> <p><code>render props</code> 的注意问题还是对 <code>children</code> 的校验，和组合模式不同的是，这种模式需要校验 <code>children</code> 是一个函数，只有是函数的情况下，才能执行函数，传递 <code>props</code> 。打一个比方：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Container</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> renderChildren <span class="token operator">=</span>  props<span class="token punctuation">.</span>children
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> renderChildren <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">renderChildren</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'《React进阶时间指南》'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> 名称 ：</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>通过 <code>typeof</code> 判断 <code>children</code> 是一个函数，如果是函数，那么执行函数，传递 props 。</li></ul> <h3 id="_4-实践demo-2"><a href="#_4-实践demo-2" class="header-anchor">#</a> 4 实践demo</h3> <p>接下来我们实现一个 demo。通过 render props 实现一个带 loading 效果的容器组件，被容器组件包裹，会通过 props 回传开启 loading 的方法 （ 现实场景下，不一定会这么做，这里只是方便同学学习 render props 模式 ） 。</p> <p><strong>容器组件 Container</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Container</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> <span class="token punctuation">[</span> showLoading<span class="token punctuation">,</span> setShowLoading <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> renderChildren <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">{</span> setShowLoading <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span>  <span class="token punctuation">,</span><span class="token punctuation">[</span>children<span class="token punctuation">]</span> <span class="token punctuation">)</span>
   <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">position</span><span class="token operator">:</span><span class="token string">'relative'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
     </span><span class="token punctuation">{</span>renderChildren<span class="token punctuation">}</span><span class="token plain-text">
     </span><span class="token punctuation">{</span>showLoading <span class="token operator">&amp;&amp;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mastBox<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SyncOutlined</span></span>  <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">spin</span> <span class="token attr-name">twoToneColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#52c41a<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>useState</code>用于显示 loading 效果，useMemo 用于执行 <code>children</code> 函数，把改变 state 的方法 setShowLoading 传入 props 中。这里有一个好处就是当 useState 改变的时候，不会触发 <code>children</code> 的渲染。</li> <li>通过 <code>showLoading</code> 来显示 loading 效果。</li></ul> <p><strong>外层使用</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> setLoading <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> setShowLoading <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'渲染'</span><span class="token punctuation">)</span>
                setLoading<span class="token punctuation">.</span>current <span class="token operator">=</span> setShowLoading
                <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
                         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setShowLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">loading</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                     </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Container</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> setLoading<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> setLoading<span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">取消 loading </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>通过直接调用 <code>setShowLoading(true)</code>显示 loading 效果。</li> <li>用 useRef 保存状态 setShowLoading ，<code>Container</code> 外层也可以调用 setShowLoading 来让 loading 效果消失。</li></ul> <p><strong>效果</strong></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_gif/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQKJrewJLMTktBSSpaKUayiaNjSjnzA4T2AGAWarScczKSBrOZeTXK91A/640?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="图片"></p> <h3 id="_5-总结-2"><a href="#_5-总结-2" class="header-anchor">#</a> 5 总结</h3> <p>接下来我们总结一下 render props 的特点。</p> <ul><li>容器组件作用是传递状态，执行 children 函数。</li> <li>外层组件可以根据容器组件回传 props ，进行 props 组合传递给子组件。</li> <li>外层组件可以使用容器组件回传状态。</li></ul> <p>这种模式下的原理图如下所示：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQmwGpqxVYSd17Dkh3SRYfAx4BWVDfzoRsFCgmiaZCjm861OG0N8QeUKg/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="四-hoc-模式"><a href="#四-hoc-模式" class="header-anchor">#</a> 四 hoc 模式</h2> <h3 id="_1-介绍-3"><a href="#_1-介绍-3" class="header-anchor">#</a> 1 介绍</h3> <p>hoc 高阶组件模式也是 React 比较常用的一种包装强化模式之一，高阶函数是接收一个函数，返回一个函数，而所谓<strong>高阶组件，就是接收一个组件，返回一个组件，返回的组件是根据需要对原始组件的强化。</strong></p> <p>我们来看一下 hoc 的通用模式。hoc 本质上就是一个函数。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Hoc</span> <span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Wrap</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
        <span class="token comment">//---------</span>
        <span class="token comment">// 强化操作</span>
        <span class="token comment">//---------</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token spread"><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>传统的 HOC 模式如上，我们可以看清楚一个传统的 HOC 做了哪些事。</p> <ul><li>1 HOC 本质是一个函数，传入 <code>Component</code> ，也就是原始组件本身。</li> <li>2 返回一个新的包装的组件 Wrap ，我们可以在 Wrap 中做一些强化原始组件的事。</li> <li>3 Wrap 中挂载原始组件本身 <code>Component</code>。</li></ul> <h3 id="_2-原理"><a href="#_2-原理" class="header-anchor">#</a> 2 原理</h3> <p>接下来我们看一下 hoc 的具体实现原理。hoc 的实现有两种方式，<strong>属性代理</strong>和<strong>反向继承</strong>。</p> <p><strong>属性代理</strong>所谓正向属性代理，就是用组件包裹一层代理组件，在代理组件上，我们可以做一些，对源组件的代理操作。我们可以理解为父子组件关系，父组件对子组件进行一系列强化操作。而 hoc 本身就是返回强化子组件的父组件。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">WrapComponent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Advance</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
       state<span class="token operator">=</span><span class="token punctuation">{</span>
           <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'《React 进阶实践指南》'</span><span class="token punctuation">,</span>
           <span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">'我不是外星人'</span>
       <span class="token punctuation">}</span>
       <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">WrapComponent</span></span>  <span class="token spread"><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token punctuation">}</span></span>  <span class="token punctuation">/&gt;</span></span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>属性代理特点：</p> <ul><li>① 正常属性代理可以和业务组件低耦合，零耦合，对于条件渲染和 <code>props</code> 属性增强,只负责控制子组件渲染和传递额外的 <code>props</code> 就可以，所以无须知道，业务组件做了些什么。所以正向属性代理，更适合做一些开源项目的 <code>hoc</code> ，目前开源的 <code>HOC</code> 基本都是通过这个模式实现的。</li> <li>② 同样适用于 <code>class</code> 声明组件，和 <code>function</code> 声明的组件。</li> <li>③ 可以完全隔离业务组件的渲染,相比反向继承，属性代理这种模式。可以完全控制业务组件渲染与否，可以避免反向继承带来一些副作用，比如生命周期的执行。</li> <li>④ 可以嵌套使用，多个 hoc 是可以嵌套使用的，而且一般不会限制包装HOC的先后顺序。</li></ul> <p><strong>反向继承</strong></p> <p>反向继承和属性代理有一定的区别，在于包装后的组件继承了业务组件本身，所以我们我无须再去实例化我们的业务组件。当前高阶组件就是继承后，加强型的业务组件。这种方式类似于组件的强化，所以你必须要知道当前继承的组件的状态，内部做了些什么？</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> hello,world  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">wrapComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span> <span class="token comment">/* 直接继承需要包装的组件 */</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">HOC</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span> 
</code></pre></div><ul><li>① 方便获取组件内部状态，比如state，props ,生命周期,绑定的事件函数等</li> <li>② es6继承可以良好继承静态属性。我们无须对静态属性和方法进行额外的处理。</li></ul> <h3 id="_3-功能及注意事项"><a href="#_3-功能及注意事项" class="header-anchor">#</a> 3 功能及注意事项</h3> <p>上面介绍了 hoc 的二种实现方式，接下来看一下 hoc 能做些什么？以及 hoc 模式的注意事项。</p> <p><strong>HOC 的功能</strong></p> <p>对于属性代理HOC，我们可以：</p> <ul><li>强化props &amp; 抽离state。</li> <li>条件渲染，控制渲染，分片渲染，懒加载。</li> <li>劫持事件和生命周期。</li> <li>ref控制组件实例。</li> <li>添加事件监听器，日志</li></ul> <p>对于反向代理的HOC,我们可以：</p> <ul><li>劫持渲染，操纵渲染树。</li> <li>控制/替换生命周期，直接获取组件状态，绑定事件。</li></ul> <p>如果你对上面的每一个功能的具体场景不清楚的话，建议看一下笔者的另外一篇文章：一文吃透React高阶组件(HOC)</p> <p><strong>HOC 注意事项</strong></p> <ul><li>1 谨慎修改原型链。</li> <li>2 继承静态属性，这里推荐一个库 <code>hoist-non-react-statics</code> 自动拷贝所有的静态方法。</li> <li>3 跨层级捕获 <code>ref</code>，通过 <code>forwardRef</code>转发 <code>ref</code>。</li> <li>4 render 中不要声明 <code>HOC</code>，如果在 render 声明 hoc，可能会造成组件反复挂载情况发生。</li></ul> <h3 id="_4-实践demo-3"><a href="#_4-实践demo-3" class="header-anchor">#</a> 4 实践demo</h3> <p>之前有同学在面试中，遇到了这样一个问题，就是如果控制组件挂载的先后顺序，比如如下的场景</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentA</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentB</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentC</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>如上，有三个子组件，<code>ComponentA</code> ，<code>ComponentB</code>，<code>ComponentC</code>，现在期望执行顺序是 <code>ComponentA</code> 渲染完成，挂载 <code>ComponentB</code> ，<code>ComponentB</code> 渲染完成，挂载 <code>ComponentC</code>，也就是三个组件是按照先后顺序渲染挂载的，那么如何实现呢？</p> <p>实际上，这种情况完全可以用一个 hoc 来实现，那么接下来，请大家跟上我的思路实现这个场景。
首先这个 hoc 是针对当前 index 下面，<code>ComponentA ｜ ComponentB ｜ ComponentC</code> 一组 <code>component</code> 进行功能强化。所以这个 hoc 最好可以动态创建，而且服务于当前一组组件。那么可以声明一个生产 hoc 的函数工厂。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">createHoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> renderQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token comment">/* 待渲染队列 */</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">/* Component - 原始组件   */</span>
        <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Wrap</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>  <span class="token comment">/* hoc 包装组件 */</span>
         
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么我们需要先创建一个 hoc，作为这一组组件的使用。</p> <p><strong>使用：</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> loadingHoc <span class="token operator">=</span> <span class="token function">createHoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>知道了 hoc 的动态产生，接下来具体实现一下这个 hoc 。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">createHoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> renderQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">/* 待渲染队列 */</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">function</span> <span class="token function">RenderController</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">/* RenderController 用于真正挂载原始组件  */</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> renderNextComponent <span class="token punctuation">,</span><span class="token operator">...</span>otherprops  <span class="token punctuation">}</span> <span class="token operator">=</span> props
            <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">renderNextComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 通知执行下一个需要挂载的组件任务 */</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span>  <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>otherprops<span class="token punctuation">}</span></span>  <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Wrap</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
            <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">isRender</span><span class="token operator">:</span><span class="token boolean">false</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">const</span> <span class="token function-variable function">tryRender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">isRender</span><span class="token operator">:</span><span class="token boolean">true</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>renderQueue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isFirstRender <span class="token operator">=</span> <span class="token boolean">true</span>
                renderQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tryRender<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            isFirstRender <span class="token operator">=</span> <span class="token boolean">false</span>      <span class="token comment">/* 是否是队列中的第一个挂载任务 */</span>
            <span class="token function-variable function">renderNextComponent</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>  <span class="token comment">/* 从更新队列中，取出下一个任务，进行挂载 */</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>renderQueue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'挂载下一个组件'</span><span class="token punctuation">)</span>
                    <span class="token keyword">const</span> nextRender <span class="token operator">=</span> renderQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token function">nextRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">/* 如果是第一个挂载任务，那么需要 */</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>isFirstRender <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderNextComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> isRender <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
                <span class="token keyword">return</span> isRender <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RenderController</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span></span> <span class="token attr-name">renderNextComponent</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderNextComponent<span class="token punctuation">}</span></span>  <span class="token punctuation">/&gt;</span></span> <span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SyncOutlined</span></span>   <span class="token attr-name">spin</span> <span class="token punctuation">/&gt;</span></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>分析一下主要流程：</p> <ul><li>首先通过 <code>createHoc</code> 来创建需要顺序加载的 hoc ，<code>renderQueue</code> 存放待渲染的队列。</li> <li>Hoc 接收原始组件 <code>Component</code>。</li> <li><code>RenderController</code> 用于真正挂载原始组件，用 useEffect 通知执行下一个需要挂载的组件任务，在 hooks 原理的文章中，我讲过 <strong>useEffect</strong> 采用异步执行，也就是说明，是在渲染之后，浏览器绘制已经完成。</li> <li>Wrap 组件包装了一层 <code>RenderController</code>，主要用于渲染更新任务，<code>isFirstRender</code>证明是否是队列中的第一个挂载任务，如果是第一个挂载任务，那么需要在 <code>componentDidMount</code> 开始挂载第一个组件。</li> <li>每一个挂载任务本质上就是 <code>tryRender</code> 方法，里面调用了 setState 来渲染 <code>RenderController</code>。</li> <li>每一个挂载任务的函数 <code>renderNextComponent</code> 原理很简单，就是获取第一个更新任务，然后执行就可以了。</li> <li>还有一些细节没有处理，比如说继承静态属性，ref 转发等。</li></ul> <p><strong>使用：</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">/* 创建 hoc  */</span>
<span class="token keyword">const</span> loadingHoc <span class="token operator">=</span> <span class="token function">createHoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">CompA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件A挂载完成'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">组件 A </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">CompB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件B挂载完成'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">组件 B </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">CompC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件C挂载完成'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">组件 C </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">CompD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件D挂载完成'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">组件 D </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">CompE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件E挂载完成'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">组件 E </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> ComponentA <span class="token operator">=</span> <span class="token function">loadingHoc</span><span class="token punctuation">(</span>CompA<span class="token punctuation">)</span>
<span class="token keyword">const</span> ComponentB <span class="token operator">=</span> <span class="token function">loadingHoc</span><span class="token punctuation">(</span>CompB<span class="token punctuation">)</span>
<span class="token keyword">const</span> ComponentC <span class="token operator">=</span> <span class="token function">loadingHoc</span><span class="token punctuation">(</span>CompC<span class="token punctuation">)</span>
<span class="token keyword">const</span> ComponentD <span class="token operator">=</span> <span class="token function">loadingHoc</span><span class="token punctuation">(</span>CompD<span class="token punctuation">)</span>
<span class="token keyword">const</span> ComponentE <span class="token operator">=</span> <span class="token function">loadingHoc</span><span class="token punctuation">(</span>CompE<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> isShow<span class="token punctuation">,</span> setIsShow <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentA</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentB</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentC</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>isShow <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentD</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token punctuation">{</span>isShow <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentE</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setIsShow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text"> 挂载组件D ，E </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>效果：</strong></p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片"><img src="https://mmbiz.qpic.cn/mmbiz_gif/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQl9tXGeh4ls3ekAA5QWcocIwqBD5h4RO0ibOcUaXdiaMibAJoImsCfgIuQ/640?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="图片" style="zoom:50%;"></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQU2wPWV8ZJ0etGnaqtyXxia5j8FLaUN9VUlpFSy0IqjG5Lvnjewas5Sw/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>完美达成需求。</p> <h3 id="_5-总结-3"><a href="#_5-总结-3" class="header-anchor">#</a> 5 总结</h3> <p>HOC 在实际项目中，应用还是很广泛的，尤其是一些优秀的开源项目中，这里总结了一下 HOC 的原理图：</p> <p><strong>属性代理</strong></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQIlGS12SM42wyU8icTMKXZPVUMhY59qNmgMDdJBXKwNbicmTCtChRtOTw/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p><strong>反向继承</strong></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQJeyYUyQ5CqT5X89fEtYmdTMDBXJrTFYZzoohVia95YAguUoS3yia8QwQ/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="五-提供者模式"><a href="#五-提供者模式" class="header-anchor">#</a> 五 提供者模式</h2> <h3 id="_1-介绍-4"><a href="#_1-介绍-4" class="header-anchor">#</a> 1 介绍</h3> <p>首先我们来思考一下，为什么 React 会有提供者这种模式呢？</p> <p>带着这个疑问，首先假设一个场景：在 React 的项目有一个全局变量 <code>theme</code> （ <code>theme</code> 可能是初始化数据交互获得的，也有可能是切换主题变化的），有一些视图 UI 组件（比如表单 <code>input</code> 框、 <code>button</code> 按钮），需要 <code>theme</code> 里面的变量来做对应的视图渲染，现在的问题是怎么能够把 <code>theme</code> 传递下去，合理分配到用到这个 <code>theme</code> 的地方。</p> <p>如果用 <code>props</code> 解决这个问题，那么需要通过 <code>props</code> 层层绑定，而且还要考虑 <code>pureComponent</code>， <code>memo</code> 策略的影响。</p> <p>所以这个时候用提供者模式最好不过了。React 提供了 context <code>提供者</code>模式，具体模式是这样的，React组件树 Root 节点，用 Provider 提供者注入 theme，然后在需要 theme的 地方，用 Consumer 消费者形式取出theme，供给组件渲染使用即可，这样减少很多无用功。用官网上的一句话形容就是Context 提供了一个无需为每层组件手动添加 props，就能在组件树间进行数据传递的方法。</p> <p>但是必须注意一点是，提供者永远要在消费者上层，正所谓水往低处流，提供者一定要是消费者的某一层父级。提供者模式的结构图如下：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQ4DYkOPibfEILmtjhrLwt3RIIS5mzoibGA3rmgFiafniamWicM8Sdiae1YIOw/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h3 id="_2-用法介绍"><a href="#_2-用法介绍" class="header-anchor">#</a> 2 用法介绍</h3> <p>对于提供者模式的用法，有老版本的 context 和新版本的 context 之分。接下来重点介绍一下两种方式。</p> <h4 id="老版本提供者模式"><a href="#老版本提供者模式" class="header-anchor">#</a> 老版本提供者模式</h4> <p>在 React v16.3.0 之前，要实现提供者，就要实现一个 React 组件，不过这个组件要做特殊处理。下面就是一个实现“提供者”的例子，组件名为 <code>ThemeProvider</code>：</p> <p><strong>提供者</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">ThemeProvider</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">getChildContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">theme</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         </span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ThemeProvider<span class="token punctuation">.</span>childContextTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">theme</span><span class="token operator">:</span> PropTypes<span class="token punctuation">.</span>object
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需要实现 <code>getChildContext</code> 方法，用于返回数据就是向子孙组件传递的上下文；</li> <li>需要定义 <code>childContextTypes</code> 属性，声明“上下文”的结构类型。</li></ul> <p><strong>使用</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ThemeProvider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">'pink'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ThemeProvider</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>消费者</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> <span class="token function-variable function">ThemeConsumer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>color<span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>theme
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>color <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ThemeConsumer<span class="token punctuation">.</span>contextTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">theme</span><span class="token operator">:</span> PropTypes<span class="token punctuation">.</span>object
<span class="token punctuation">}</span>
</code></pre></div><ul><li>这里需要注意的是，需要通过 <code>contextTypes</code> 指定将要消费哪个 context ，否则将无效。</li></ul> <h4 id="新版本提供者模式"><a href="#新版本提供者模式" class="header-anchor">#</a> 新版本提供者模式</h4> <p>到了 React v16.3.0 的时候，新的 Context API 出来了，开发者可以创建一个 Context ， Context 上有两个属性就是 <code>Provider</code> 和 <code>Consumer</code> 。</p> <ul><li><code>Provider</code> 用于提供 context 。</li> <li><code>Consumer</code> 用于消费 context 。</li></ul> <p>那么接下来介绍一下具体如何使用，首先开发者需要用 createContext api 创建一个 context。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后就是新版本 <code>Provider</code> 和 <code>Consumer</code>的实现。</p> <p><strong>新版提供者</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">ThemeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">'pink'</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ThemeContext.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> theme <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ThemeContext.Provider</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>通过 <code>ThemeContext</code> 上的 <code>Provider</code> 传递主题信息 <code>theme</code> 。</li> <li><code>Index</code> 是根部组件。</li></ul> <p><strong>新版消费者</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">ThemeConsumer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ThemeContext.Consumer</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token parameter">theme</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">/* render children函数 */</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> color <span class="token punctuation">}</span> <span class="token operator">=</span> theme
          <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>color <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
           </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ThemeContext.Consumer</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>Consumer</code> 采用的就是上述讲到的 <code>render props</code> 模式。</li> <li>通过 <code>Consumer</code> 订阅 <code>context</code> 变化，<code>context</code> 变化， <code>render children</code> 函数重新执行。<code>render children</code> 函数中第一个参数就是保存的 <code>context</code> 信息。</li> <li>在新版消费者中，对于函数组件还有 <code>useContext</code> 自定义 <code>hooks</code> ，对于类组件有 <code>contextType</code> 静态属性。</li></ul> <h3 id="_3-实践demo"><a href="#_3-实践demo" class="header-anchor">#</a> 3 实践demo</h3> <p>接下来我们实现一个提供者模式的实践 demo ，通过动态 context 来让消费 context 的 <code>Consumer</code> 动态渲染。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个 context 上下文 ,主题颜色Context</span>

<span class="token keyword">function</span> <span class="token function">ConsumerDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
         </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ThemeContext.Consumer</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token parameter">theme</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token operator">...</span>theme<span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">i am alien!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">let us learn React!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
             </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ThemeContext.Consumer</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span><span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerDemo</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ProviderDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> theme <span class="token punctuation">,</span> setTheme <span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">'pink'</span> <span class="token punctuation">,</span> <span class="token literal-property property">background</span><span class="token operator">:</span><span class="token string">'#ccc'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ThemeContext.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span></span>  <span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span>  <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ThemeContext.Provider</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">setTheme</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">'blue'</span> <span class="token punctuation">,</span> <span class="token literal-property property">background</span><span class="token operator">:</span><span class="token string">'orange'</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">点击</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Provider 改变，消费订阅 Provider 的 Consumer 会重新渲染。</li></ul> <p><strong>效果：</strong></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_gif/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQpj65gDmDQUrsHey1E929lvOY2vjYFa1MkUicPkNuZ59icOZyepIXCaibA/640?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="图片"></p> <h3 id="_4-总结"><a href="#_4-总结" class="header-anchor">#</a> 4 总结</h3> <p>提供者模式在日常开发中，用的频率还是很高的，比如全局传递状态，保存状态。这里用一幅图总结提供者模式的原理。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQFqiawgezQ3NpnW395DBAgdBVFDW1MEGoicacmkC6oZD7LQGsv5WPaEYg/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="六-类组件继承"><a href="#六-类组件继承" class="header-anchor">#</a> 六 类组件继承</h2> <h3 id="_1-介绍-5"><a href="#_1-介绍-5" class="header-anchor">#</a> 1 介绍</h3> <blockquote><p>React 有十分强大的组合模式。我们推荐使用组合而非继承来实现组件间的代码重用
虽然 React 官方推荐<strong>用组合方式</strong>，而<strong>非继承方式</strong>。但是也不是说明继承这种方式没有用武之地，继承方式还是有很多应用场景的。</p></blockquote> <p>在 <code>class</code> 组件盛行之后，我们可以通过继承的方式进一步的强化我们的组件。这种模式的好处在于，可以封装基础功能组件，然后根据需要去<code>extends</code> 我们的基础组件，按需强化组件，但是值得注意的是，必须要对基础组件有足够的掌握，否则会造成一些列意想不到的情况发生。</p> <p>我们先来看一个</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'《React 进阶实践之指南》'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'base components'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> hello,world </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">点击</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">Base</span><span class="token punctuation">{</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* 会覆盖基类中的 say  */</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'extends components'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Index
</code></pre></div><ul><li><code>Base</code> 为基础组件，提供一些基础的方法和功能，包括 UI</li> <li><code>Index</code> 为基于 Base 继承的组件，可以针对 Index 做一些功能性的强化。</li></ul> <h3 id="_2-特性"><a href="#_2-特性" class="header-anchor">#</a> 2 特性</h3> <p>继承增强效果很优秀。它的优势如下：</p> <ul><li>可以控制父类 render，还可以添加一些其他的渲染内容；</li> <li>可以共享父类方法，还可以添加额外的方法和属性。</li></ul> <p>但是也有值得注意的地方，就是 <code>state</code> 和生命周期会被继承后的组件修改。像上述 <code>demo</code>中， <code>Person</code> 组件中的 <code>componentDidMount</code> 生命周期将不会被执行。</p> <h3 id="_3-实践demo-2"><a href="#_3-实践demo-2" class="header-anchor">#</a> 3 实践demo</h3> <p>接下来我们实现一个继承功能，继承的组件就是耳熟能详的 React-Router 中的 Route 组件，强化它，使它变成可以受到权限的控制。</p> <ul><li>当页面有权限，那么直接展示页面内容。</li> <li>当页面没有权限，那么展示无权限页面。</li></ul> <p><strong>代码编写</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span>

<span class="token keyword">const</span> RouterPermission <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">PRoute</span> <span class="token keyword">extends</span> <span class="token class-name">Route</span><span class="token punctuation">{</span>
    <span class="token keyword">static</span> contextType <span class="token operator">=</span> RouterPermission  <span class="token comment">/* 使用 context */</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">...</span>arg<span class="token punctuation">)</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props
        <span class="token comment">/* 如果有权限 */</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span>
        <span class="token keyword">const</span> isPermiss <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token comment">/* 判断是否有权限 */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isPermiss<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* 修改 render 函数，如果没有权限，重新渲染一个 Route ，ui 是无权限展示的内容  */</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span>  <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span></span>   <span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">暂无权限</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">/* 模拟的有权限的路由列表 */</span>
    <span class="token keyword">const</span> permissionList <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'/extends/a'</span> <span class="token punctuation">,</span> <span class="token string">'/extends/b'</span>  <span class="token punctuation">]</span>
   <span class="token keyword">return</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RouterPermission.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>permissionList<span class="token punctuation">}</span></span> <span class="token punctuation">&gt;</span></span><span class="token plain-text">
       </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
   </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">RouterPermission.Provider</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在根组件传入权限路由。通过 context 模式，保存的是存在权限的路由列表。这里模拟为 <code>/extends/a</code> 和 <code>/extends/b</code>。</li> <li>编写 PRoute 权限路由，继承 <code>react-router</code> 中的 <code>Route</code> 组件。</li> <li>PRoute 通过 <code>contextType</code> 消费指定的权限上下文 <code>RouterPermission context</code>。</li> <li>在 <code>constructor</code> 中进行判断，如果有权限，那么不用做任何处理，如果没有权限，那么重写 render 函数，用 Route 做一个展示容器，展示无权限的 UI 。</li></ul> <p><strong>使用</strong></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">Test1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">权限路由测试一</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Test2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">权限路由测试二</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">权限路由测试三</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> history <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> routerlist<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'测试一'</span> <span class="token punctuation">,</span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">'/extends/a'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'测试二'</span> <span class="token punctuation">,</span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">'/extends/b'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'测试三'</span> <span class="token punctuation">,</span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">'/extends/c'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
            routerlist<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span>
                <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">}</span></span>
                                  <span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>path<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PRoute</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Test1<span class="token punctuation">}</span></span>
            <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/extends/a<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PRoute</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Test2<span class="token punctuation">}</span></span>
            <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/extends/b<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PRoute</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Test3<span class="token punctuation">}</span></span>
            <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/extends/c<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>效果</strong></p> <p><img src="https://mmbiz.qpic.cn/mmbiz_gif/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQAicvT8TWXUlaxXdq6H1o4iaGyvPZfmwxeDbqG2Jvib03uib7yPLxibwT8Jg/640?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="图片"></p> <ul><li>可以看到，只有权限列表中的 <code>[ '/extends/a' , '/extends/b' ]</code> 权限能展示，无权限提示暂无权限，完美达到效果。</li></ul> <h3 id="_4-总结-2"><a href="#_4-总结-2" class="header-anchor">#</a> 4 总结</h3> <p>继承模式的应用前提是，你需要知道被继承的组件是什么，内部都有什么状态和方法，对继承的组件内部的运转是透明的。接下来用一幅图表示继承模式原理。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/2KticQlBJtdyI2Qx7gJshibU4oE4E7VJsQhoj2kGSzlozMTIQB5JRvMtjRax1uBONTHbImm9wjqh2MIzz0R1vZxw/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h2 id="七-总结"><a href="#七-总结" class="header-anchor">#</a> 七 总结</h2> <p>本章节讲了 React 中常用的几个设计模式。希望同学们看完可以手动敲起来，把这些设计模式运用到真实的项目中。</p> <h3 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h3> <p>「react进阶」一文吃透React高阶组件(HOC)</p> <p>React进阶实践指南</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/24/2022, 11:56:22 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/前端架构之React领域驱动设计.html" class="prev">
        前端架构之 React 领域驱动设计
      </a></span> <span class="next"><a href="/advanced/浅谈React中的XSS攻击.html">
        浅谈 React 中的 XSS 攻击
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.c06c5691.js" defer></script><script src="/assets/js/2.e21ead49.js" defer></script><script src="/assets/js/24.a72c373a.js" defer></script>
  </body>
</html>
