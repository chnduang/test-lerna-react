(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{447:function(t,a,s){"use strict";s.r(a);var e=s(18),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"深入分析虚拟-dom-的渲染原理和特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#深入分析虚拟-dom-的渲染原理和特性"}},[t._v("#")]),t._v(" 深入分析虚拟 dom 的渲染原理和特性")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/react11.png",alt:"image"}})]),t._v(" "),s("h2",{attrs:{id:"导读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#导读"}},[t._v("#")]),t._v(" 导读")]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("的虚拟"),s("code",[t._v("DOM")]),t._v("和"),s("code",[t._v("Diff")]),t._v("算法是"),s("code",[t._v("React")]),t._v("的非常重要的核心特性，这部分源码也非常复杂，理解这部分知识的原理对更深入的掌握"),s("code",[t._v("React")]),t._v("是非常必要的。")]),t._v(" "),s("p",[t._v("本来想将虚拟"),s("code",[t._v("DOM")]),t._v("和"),s("code",[t._v("Diff")]),t._v("算法放到一篇文章，写完虚拟"),s("code",[t._v("DOM")]),t._v("发现文章已经很长了，所以本篇只分析虚拟"),s("code",[t._v("DOM")]),t._v("。")]),t._v(" "),s("p",[t._v("本篇文章从源码出发，分析虚拟"),s("code",[t._v("DOM")]),t._v("的核心渲染原理（首次渲染），以及"),s("code",[t._v("React")]),t._v("对它做的性能优化点。")]),t._v(" "),s("p",[t._v("说实话"),s("code",[t._v("React")]),t._v("源码真的很难读 😅，如果本篇文章帮助到了你，那么请给个赞 👍 支持一下吧。")]),t._v(" "),s("h2",{attrs:{id:"开发中的常见问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发中的常见问题"}},[t._v("#")]),t._v(" 开发中的常见问题")]),t._v(" "),s("ul",[s("li",[t._v("为何必须引用"),s("code",[t._v("React")])]),t._v(" "),s("li",[t._v("自定义的"),s("code",[t._v("React")]),t._v("组件为何必须大写")]),t._v(" "),s("li",[s("code",[t._v("React")]),t._v("如何防止"),s("code",[t._v("XSS")])]),t._v(" "),s("li",[s("code",[t._v("React")]),t._v("的"),s("code",[t._v("Diff")]),t._v("算法和其他的"),s("code",[t._v("Diff")]),t._v("算法有何区别")]),t._v(" "),s("li",[s("code",[t._v("key")]),t._v("在"),s("code",[t._v("React")]),t._v("中的作用")]),t._v(" "),s("li",[t._v("如何写出高性能的"),s("code",[t._v("React")]),t._v("组件")])]),t._v(" "),s("p",[t._v("如果你对上面几个问题还存在疑问，说明你对"),s("code",[t._v("React")]),t._v("的虚拟"),s("code",[t._v("DOM")]),t._v("以及"),s("code",[t._v("Diff")]),t._v("算法实现原理还有所欠缺，那么请好好阅读本篇文章吧。")]),t._v(" "),s("p",[t._v("首先我们来看看到底什么是虚拟"),s("code",[t._v("DOM")]),t._v(":")]),t._v(" "),s("h2",{attrs:{id:"虚拟-dom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom"}},[t._v("#")]),t._v(" 虚拟 DOM")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/%E8%99%9A%E6%8B%9Fdom.png",alt:"image"}})]),t._v(" "),s("p",[t._v("在原生的"),s("code",[t._v("JavaScript")]),t._v("程序中，我们直接对"),s("code",[t._v("DOM")]),t._v("进行创建和更改，而"),s("code",[t._v("DOM")]),t._v("元素通过我们监听的事件和我们的应用程序进行通讯。")]),t._v(" "),s("p",[t._v("而"),s("code",[t._v("React")]),t._v("会先将你的代码转换成一个"),s("code",[t._v("JavaScript")]),t._v("对象，然后这个"),s("code",[t._v("JavaScript")]),t._v("对象再转换成真实"),s("code",[t._v("DOM")]),t._v("。这个"),s("code",[t._v("JavaScript")]),t._v("对象就是所谓的虚拟"),s("code",[t._v("DOM")]),t._v("。")]),t._v(" "),s("p",[t._v("比如下面一段"),s("code",[t._v("html")]),t._v("代码：")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("title"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("span")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("Hello ConardLi"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("span")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("苹果"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("橘子"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("在"),s("code",[t._v("React")]),t._v("可能存储为这样的"),s("code",[t._v("JS")]),t._v("代码：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" VitrualDom "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"div"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("props")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"title"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("children")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"span"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("children")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello ConardLi"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ul"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("children")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ul"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("children")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"苹果"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ul"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("children")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"橘子"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("当我们需要创建或更新元素时，"),s("code",[t._v("React")]),t._v("首先会让这个"),s("code",[t._v("VitrualDom")]),t._v("对象进行创建和更改，然后再将"),s("code",[t._v("VitrualDom")]),t._v("对象渲染成真实"),s("code",[t._v("DOM")]),t._v("；")]),t._v(" "),s("p",[t._v("当我们需要对"),s("code",[t._v("DOM")]),t._v("进行事件监听时，首先对"),s("code",[t._v("VitrualDom")]),t._v("进行事件监听，"),s("code",[t._v("VitrualDom")]),t._v("会代理原生的"),s("code",[t._v("DOM")]),t._v("事件从而做出响应。")]),t._v(" "),s("h2",{attrs:{id:"为何使用虚拟-dom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为何使用虚拟-dom"}},[t._v("#")]),t._v(" 为何使用虚拟 DOM")]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("为何采用"),s("code",[t._v("VitrualDom")]),t._v("这种方案呢？")]),t._v(" "),s("h3",{attrs:{id:"提高开发效率"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#提高开发效率"}},[t._v("#")]),t._v(" 提高开发效率")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("JavaScript")]),t._v("，我们在编写应用程序时的关注点在于如何更新"),s("code",[t._v("DOM")]),t._v("。")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("React")]),t._v("，你只需要告诉"),s("code",[t._v("React")]),t._v("你想让视图处于什么状态，"),s("code",[t._v("React")]),t._v("则通过"),s("code",[t._v("VitrualDom")]),t._v("确保"),s("code",[t._v("DOM")]),t._v("与该状态相匹配。你不必自己去完成属性操作、事件处理、"),s("code",[t._v("DOM")]),t._v("更新，"),s("code",[t._v("React")]),t._v("会替你完成这一切。")]),t._v(" "),s("p",[t._v("这让我们更关注我们的业务逻辑而非"),s("code",[t._v("DOM")]),t._v("操作，这一点即可大大提升我们的开发效率。")]),t._v(" "),s("h3",{attrs:{id:"关于提升性能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关于提升性能"}},[t._v("#")]),t._v(" 关于提升性能")]),t._v(" "),s("p",[t._v("很多文章说"),s("code",[t._v("VitrualDom")]),t._v("可以提升性能，这一说法实际上是很片面的。")]),t._v(" "),s("p",[t._v("直接操作"),s("code",[t._v("DOM")]),t._v("是非常耗费性能的，这一点毋庸置疑。但是"),s("code",[t._v("React")]),t._v("使用"),s("code",[t._v("VitrualDom")]),t._v("也是无法避免操作"),s("code",[t._v("DOM")]),t._v("的。")]),t._v(" "),s("p",[t._v("如果是首次渲染，"),s("code",[t._v("VitrualDom")]),t._v("不具有任何优势，甚至它要进行更多的计算，消耗更多的内存。")]),t._v(" "),s("p",[s("code",[t._v("VitrualDom")]),t._v("的优势在于"),s("code",[t._v("React")]),t._v("的"),s("code",[t._v("Diff")]),t._v("算法和批处理策略，"),s("code",[t._v("React")]),t._v("在页面更新之前，提前计算好了如何进行更新和渲染"),s("code",[t._v("DOM")]),t._v("。实际上，这个计算过程我们在直接操作"),s("code",[t._v("DOM")]),t._v("时，也是可以自己判断和实现的，但是一定会耗费非常多的精力和时间，而且往往我们自己做的是不如"),s("code",[t._v("React")]),t._v("好的。所以，在这个过程中"),s("code",[t._v("React")]),t._v('帮助我们"提升了性能"。')]),t._v(" "),s("p",[t._v("所以，我更倾向于说，"),s("code",[t._v("VitrualDom")]),t._v("帮助我们提高了开发效率，在重复渲染时它帮助我们计算如何更高效的更新，而不是它比"),s("code",[t._v("DOM")]),t._v("操作更快。")]),t._v(" "),s("p",[t._v("如果您对本部分的分析有什么不同见解，欢迎在评论区拍砖。")]),t._v(" "),s("h3",{attrs:{id:"跨浏览器兼容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#跨浏览器兼容"}},[t._v("#")]),t._v(" 跨浏览器兼容")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/diff3.jpg",alt:"image"}})]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("基于"),s("code",[t._v("VitrualDom")]),t._v("自己实现了一套自己的事件机制，自己模拟了事件冒泡和捕获的过程，采用了事件代理，批量更新等方法，抹平了各个浏览器的事件兼容性问题。")]),t._v(" "),s("h3",{attrs:{id:"跨平台兼容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#跨平台兼容"}},[t._v("#")]),t._v(" 跨平台兼容")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/rn.png",alt:"image"}})]),t._v(" "),s("p",[s("code",[t._v("VitrualDom")]),t._v("为"),s("code",[t._v("React")]),t._v("带来了跨平台渲染的能力。以"),s("code",[t._v("React Native")]),t._v("为例子。"),s("code",[t._v("React")]),t._v("根据"),s("code",[t._v("VitrualDom")]),t._v("画出相应平台的"),s("code",[t._v("ui")]),t._v("层，只不过不同平台画的姿势不同而已。")]),t._v(" "),s("h2",{attrs:{id:"虚拟-dom-实现原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom-实现原理"}},[t._v("#")]),t._v(" 虚拟 DOM 实现原理")]),t._v(" "),s("p",[t._v("如果你不想看繁杂的源码，或者现在没有足够时间，可以跳过这一章，直接 👇"),s("a",{attrs:{href:"http://www.conardli.top/blog/article/React%E6%B7%B1%E5%85%A5%E7%B3%BB%E5%88%97/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86%E5%92%8C%E7%89%B9%E6%80%A7.html#%E8%99%9A%E6%8B%9FDOM%E5%8E%9F%E7%90%86%E3%80%81%E7%89%B9%E6%80%A7%E6%80%BB%E7%BB%93",target:"_blank",rel:"noopener noreferrer"}},[t._v("虚拟 DOM 原理总结"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/%E8%99%9A%E6%8B%9Fdom2.png",alt:"image"}})]),t._v(" "),s("p",[t._v("在上面的图上我们继续进行扩展，按照图中的流程，我们依次来分析虚拟"),s("code",[t._v("DOM")]),t._v("的实现原理。")]),t._v(" "),s("h3",{attrs:{id:"jsx-和-createelement"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jsx-和-createelement"}},[t._v("#")]),t._v(" JSX 和 createElement")]),t._v(" "),s("p",[t._v("我们在实现一个"),s("code",[t._v("React")]),t._v("组件时可以选择两种编码方式，第一种是使用"),s("code",[t._v("JSX")]),t._v("编写：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Hello")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("Hello ConardLi"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("第二种是直接使用"),s("code",[t._v("React.createElement")]),t._v("编写：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Hello")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"div"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Hello ConardLi")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("实际上，上面两种写法是等价的，"),s("code",[t._v("JSX")]),t._v("只是为 "),s("code",[t._v("React.createElement(component, props, ...children)")]),t._v("方法提供的语法糖。也就是说所有的"),s("code",[t._v("JSX")]),t._v("代码最后都会转换成"),s("code",[t._v("React.createElement(...)")]),t._v("，"),s("code",[t._v("Babel")]),t._v("帮助我们完成了这个转换的过程。")]),t._v(" "),s("p",[t._v("如下面的"),s("code",[t._v("JSX")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("img src"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"avatar.png"')]),t._v(" className"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"profile"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Hello "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("p",[t._v("将会被"),s("code",[t._v("Babel")]),t._v("转换为")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("React"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"div"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  React"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"img"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"avatar.png"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"profile"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  React"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Hello"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("注意，"),s("code",[t._v("babel")]),t._v("在编译时会判断"),s("code",[t._v("JSX")]),t._v("中组件的首字母，当首字母为小写时，其被认定为原生"),s("code",[t._v("DOM")]),t._v("标签，"),s("code",[t._v("createElement")]),t._v("的第一个变量被编译为字符串；当首字母为大写时，其被认定为自定义组件，"),s("code",[t._v("createElement")]),t._v("的第一个变量被编译为对象；")]),t._v(" "),s("p",[t._v("另外，由于"),s("code",[t._v("JSX")]),t._v("提前要被"),s("code",[t._v("Babel")]),t._v("编译，所以"),s("code",[t._v("JSX")]),t._v("是不能在运行时动态选择类型的，比如下面的代码：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Story")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Wrong! JSX type can't be an expression.")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("components"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("storyType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" story"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("story"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("需要变成下面的写法：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Story")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Correct! JSX type can be a capitalized variable.")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" SpecificStory "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" components"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("storyType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("SpecificStory story"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("story"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("所以，使用"),s("code",[t._v("JSX")]),t._v("你需要安装"),s("code",[t._v("Babel")]),t._v("插件"),s("code",[t._v("babel-plugin-transform-react-jsx")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"plugins"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transform-react-jsx"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v('"pragma"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"React.createElement"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"创建虚拟-dom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建虚拟-dom"}},[t._v("#")]),t._v(" 创建虚拟 DOM")]),t._v(" "),s("p",[t._v("下面我们来看看虚拟"),s("code",[t._v("DOM")]),t._v("的真实模样，将下面的"),s("code",[t._v("JSX")]),t._v("代码在控制台打印出来：")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("className")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("title"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("span")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("Hello ConardLi"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("span")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("苹果"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("橘子"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/diff2.png",alt:"image"}})]),t._v(" "),s("p",[t._v("这个结构和我们上面自己描绘的结构很像，那么"),s("code",[t._v("React")]),t._v("是如何将我们的代码转换成这个结构的呢，下面我们来看看"),s("code",[t._v("createElement")]),t._v("函数的具体实现（文中的源码经过精简）。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom1.png",alt:"image"}})]),t._v(" "),s("p",[s("code",[t._v("createElement")]),t._v("函数内部做的操作很简单，将"),s("code",[t._v("props")]),t._v("和子元素进行处理后返回一个"),s("code",[t._v("ReactElement")]),t._v("对象，下面我们来逐一分析：")]),t._v(" "),s("p",[s("strong",[t._v("(1).处理 props：")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom2.png",alt:"image"}})]),t._v(" "),s("ul",[s("li",[t._v("1.将特殊属性"),s("code",[t._v("ref")]),t._v("、"),s("code",[t._v("key")]),t._v("从"),s("code",[t._v("config")]),t._v("中取出并赋值")]),t._v(" "),s("li",[t._v("2.将特殊属性"),s("code",[t._v("self")]),t._v("、"),s("code",[t._v("source")]),t._v("从"),s("code",[t._v("config")]),t._v("中取出并赋值")]),t._v(" "),s("li",[t._v("3.将除特殊属性的其他属性取出并赋值给"),s("code",[t._v("props")])])]),t._v(" "),s("p",[t._v("后面的文章会详细介绍这些特殊属性的作用。")]),t._v(" "),s("p",[s("strong",[t._v("(2).获取子元素")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom3.png",alt:"image"}})]),t._v(" "),s("ul",[s("li",[t._v("1.获取子元素的个数 —— 第二个参数后面的所有参数")]),t._v(" "),s("li",[t._v("2.若只有一个子元素，赋值给"),s("code",[t._v("props.children")])]),t._v(" "),s("li",[t._v("3.若有多个子元素，将子元素填充为一个数组赋值给"),s("code",[t._v("props.children")])])]),t._v(" "),s("p",[s("strong",[t._v("(3).处理默认 props")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom4.png",alt:"image"}})]),t._v(" "),s("ul",[s("li",[t._v("将组件的静态属性"),s("code",[t._v("defaultProps")]),t._v("定义的默认"),s("code",[t._v("props")]),t._v("进行赋值")])]),t._v(" "),s("p",[s("strong",[t._v("ReactElement")])]),t._v(" "),s("p",[s("code",[t._v("ReactElement")]),t._v("将传入的几个属性进行组合，并返回。")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("type")]),t._v("：元素的类型，可以是原生 html 类型（字符串），或者自定义组件（函数或"),s("code",[t._v("class")]),t._v("）")]),t._v(" "),s("li",[s("code",[t._v("key")]),t._v("：组件的唯一标识，用于"),s("code",[t._v("Diff")]),t._v("算法，下面会详细介绍")]),t._v(" "),s("li",[s("code",[t._v("ref")]),t._v("：用于访问原生"),s("code",[t._v("dom")]),t._v("节点")]),t._v(" "),s("li",[s("code",[t._v("props")]),t._v("：传入组件的"),s("code",[t._v("props")])]),t._v(" "),s("li",[s("code",[t._v("owner")]),t._v("：当前正在构建的"),s("code",[t._v("Component")]),t._v("所属的"),s("code",[t._v("Component")])])]),t._v(" "),s("p",[s("code",[t._v("$$typeof")]),t._v("：一个我们不常见到的属性，它被赋值为"),s("code",[t._v("REACT_ELEMENT_TYPE")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REACT_ELEMENT_TYPE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" Symbol "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"function"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" Symbol"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("for "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" Symbol"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("for")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react.element"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xeac7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("可见，"),s("code",[t._v("$$typeof")]),t._v("是一个"),s("code",[t._v("Symbol")]),t._v("类型的变量，这个变量可以防止"),s("code",[t._v("XSS")]),t._v("。")]),t._v(" "),s("p",[t._v("如果你的服务器有一个漏洞，允许用户存储任意"),s("code",[t._v("JSON")]),t._v("对象， 而客户端代码需要一个字符串，这可能会成为一个问题：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// JSON")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" expectedTextButGotJSON "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"div"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("props")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("dangerouslySetInnerHTML")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("__html")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/* put your exploit here */"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" message "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("text")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" expectedTextButGotJSON "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("code",[t._v("JSON")]),t._v("中不能存储"),s("code",[t._v("Symbol")]),t._v("类型的变量。")]),t._v(" "),s("p",[s("code",[t._v("ReactElement.isValidElement")]),t._v("函数用来判断一个"),s("code",[t._v("React")]),t._v("组件是否是有效的，下面是它的具体实现。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("ReactElement"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("isValidElement")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" object "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"object"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    object "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$$"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REACT_ELEMENT_TYPE")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("可见"),s("code",[t._v("React")]),t._v("渲染时会把没有"),s("code",[t._v("$$typeof")]),t._v("标识，以及规则校验不通过的组件过滤掉。")]),t._v(" "),s("p",[t._v("当你的环境不支持"),s("code",[t._v("Symbol")]),t._v("时，"),s("code",[t._v("$$typeof")]),t._v("被赋值为"),s("code",[t._v("0xeac7")]),t._v("，至于为什么，"),s("code",[t._v("React")]),t._v("开发者给出了答案：")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("0xeac7")]),t._v("看起来有点像"),s("code",[t._v("React")]),t._v("。")])]),t._v(" "),s("p",[s("code",[t._v("self")]),t._v("、"),s("code",[t._v("source")]),t._v("只有在非生产环境才会被加入对象中。")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("self")]),t._v("指定当前位于哪个组件实例。")]),t._v(" "),s("li",[s("code",[t._v("_source")]),t._v("指定调试代码来自的文件("),s("code",[t._v("fileName")]),t._v(")和代码行数("),s("code",[t._v("lineNumber")]),t._v(")。")])]),t._v(" "),s("h3",{attrs:{id:"虚拟-dom-转换为真实-dom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom-转换为真实-dom"}},[t._v("#")]),t._v(" 虚拟 DOM 转换为真实 DOM")]),t._v(" "),s("p",[t._v("上面我们分析了代码转换成了虚拟"),s("code",[t._v("DOM")]),t._v("的过程，下面来看一下"),s("code",[t._v("React")]),t._v("如何将虚拟"),s("code",[t._v("DOM")]),t._v("转换成真实"),s("code",[t._v("DOM")]),t._v("。")]),t._v(" "),s("p",[t._v("本部分逻辑较复杂，我们先用流程图梳理一下整个过程，整个过程大概可分为四步：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/diff4.png",alt:"image"}})]),t._v(" "),s("p",[s("strong",[t._v("过程 1：初始参数处理")])]),t._v(" "),s("p",[t._v("在编写好我们的"),s("code",[t._v("React")]),t._v("组件后，我们需要调用"),s("code",[t._v("ReactDOM.render(element, container[, callback])")]),t._v("将组件进行渲染。")]),t._v(" "),s("p",[s("code",[t._v("render")]),t._v("函数内部实际调用了"),s("code",[t._v("_renderSubtreeIntoContainer")]),t._v("，我们来看看它的具体实现：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("render")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("nextElement"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ReactMount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_renderSubtreeIntoContainer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nextElement"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom6.png",alt:"image"}})]),t._v(" "),s("ul",[s("li",[t._v("1.将当前组件使用"),s("code",[t._v("TopLevelWrapper")]),t._v("进行包裹")])]),t._v(" "),s("p",[s("code",[t._v("TopLevelWrapper")]),t._v("只一个空壳，它为你需要挂载的组件提供了一个"),s("code",[t._v("rootID")]),t._v("属性，并在"),s("code",[t._v("render")]),t._v("函数中返回该组件。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TopLevelWrapper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("render")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("props"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("child"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[s("code",[t._v("ReactDOM.render")]),t._v("函数的第一个参数可以是原生"),s("code",[t._v("DOM")]),t._v("也可以是"),s("code",[t._v("React")]),t._v("组件，包裹一层"),s("code",[t._v("TopLevelWrapper")]),t._v("可以在后面的渲染中将它们进行统一处理，而不用关心是否原生。")]),t._v(" "),s("ul",[s("li",[t._v("2.判断根结点下是否已经渲染过元素，如果已经渲染过，判断执行更新或者卸载操作")]),t._v(" "),s("li",[t._v("3.处理"),s("code",[t._v("shouldReuseMarkup")]),t._v("变量，该变量表示是否需要重新标记元素")]),t._v(" "),s("li",[t._v("4.调用将上面处理好的参数传入"),s("code",[t._v("_renderNewRootComponent")]),t._v("，渲染完成后调用"),s("code",[t._v("callback")]),t._v("。")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("_renderNewRootComponent")]),t._v("中调用"),s("code",[t._v("instantiateReactComponent")]),t._v("对我们传入的组件进行分类包装：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom7.png",alt:"image"}})]),t._v(" "),s("p",[t._v("根据组件的类型，"),s("code",[t._v("React")]),t._v("根据原组件创建了下面四大类组件，对组件进行分类渲染：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("ReactDOMEmptyComponent")]),t._v(":空组件")]),t._v(" "),s("li",[s("code",[t._v("ReactDOMTextComponent")]),t._v(":文本")]),t._v(" "),s("li",[s("code",[t._v("ReactDOMComponent")]),t._v(":原生"),s("code",[t._v("DOM")])]),t._v(" "),s("li",[s("code",[t._v("ReactCompositeComponent")]),t._v(":自定义"),s("code",[t._v("React")]),t._v("组件")])]),t._v(" "),s("p",[t._v("他们都具备以下三个方法：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("construct")]),t._v(":用来接收"),s("code",[t._v("ReactElement")]),t._v("进行初始化。")]),t._v(" "),s("li",[s("code",[t._v("mountComponent")]),t._v(":用来生成"),s("code",[t._v("ReactElement")]),t._v("对应的真实"),s("code",[t._v("DOM")]),t._v("或"),s("code",[t._v("DOMLazyTree")]),t._v("。")]),t._v(" "),s("li",[s("code",[t._v("unmountComponent")]),t._v(":卸载"),s("code",[t._v("DOM")]),t._v("节点，解绑事件。")])]),t._v(" "),s("p",[t._v("具体是如何渲染我们在过程 3 中进行分析。")]),t._v(" "),s("p",[s("strong",[t._v("过程 2：批处理、事务调用")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("_renderNewRootComponent")]),t._v("中使用"),s("code",[t._v("ReactUpdates.batchedUpdates")]),t._v("调用"),s("code",[t._v("batchedMountComponentIntoNode")]),t._v("进行批处理。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("ReactUpdates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("batchedUpdates")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  batchedMountComponentIntoNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  componentInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  shouldReuseMarkup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  context\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("在"),s("code",[t._v("batchedMountComponentIntoNode")]),t._v("中，使用"),s("code",[t._v("transaction.perform")]),t._v("调用"),s("code",[t._v("mountComponentIntoNode")]),t._v("让其基于事务机制进行调用。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("perform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  mountComponentIntoNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  componentInstance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  shouldReuseMarkup"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  context\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("关于批处理事务，在我前面的分析"),s("a",{attrs:{href:"https://juejin.im/post/5c71050ef265da2db27938b5",target:"_blank",rel:"noopener noreferrer"}},[t._v("setState 执行机制"),s("OutboundLink")],1),t._v("中有更多介绍。")]),t._v(" "),s("p",[s("strong",[t._v("过程 3：生成 html")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("mountComponentIntoNode")]),t._v("函数中调用"),s("code",[t._v("ReactReconciler.mountComponent")]),t._v("生成原生"),s("code",[t._v("DOM")]),t._v("节点。")]),t._v(" "),s("p",[s("code",[t._v("mountComponent")]),t._v("内部实际上是调用了过程 1 生成的四种对象的"),s("code",[t._v("mountComponent")]),t._v("方法。首先来看一下"),s("code",[t._v("ReactDOMComponent")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/diff5.png",alt:"image"}})]),t._v(" "),s("ul",[s("li",[t._v("1.对特殊"),s("code",[t._v("DOM")]),t._v("标签、"),s("code",[t._v("props")]),t._v("进行处理。")]),t._v(" "),s("li",[t._v("2.根据标签类型创建"),s("code",[t._v("DOM")]),t._v("节点。")]),t._v(" "),s("li",[t._v("3.调用"),s("code",[t._v("_updateDOMProperties")]),t._v("将"),s("code",[t._v("props")]),t._v("插入到"),s("code",[t._v("DOM")]),t._v("节点，"),s("code",[t._v("_updateDOMProperties")]),t._v("也可用于"),s("code",[t._v("props Diff")]),t._v("，第一个参数为上次渲染的"),s("code",[t._v("props")]),t._v("，第二个参数为当前"),s("code",[t._v("props")]),t._v("，若第一个参数为空，则为首次创建。")]),t._v(" "),s("li",[t._v("4.生成一个"),s("code",[t._v("DOMLazyTree")]),t._v("对象并调用"),s("code",[t._v("_createInitialChildren")]),t._v("将孩子节点渲染到上面。")])]),t._v(" "),s("p",[t._v("那么为什么不直接生成一个"),s("code",[t._v("DOM")]),t._v("节点而是要创建一个"),s("code",[t._v("DOMLazyTree")]),t._v("呢？我们先来看看"),s("code",[t._v("_createInitialChildren")]),t._v("做了什么：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom9.png",alt:"image"}})]),t._v(" "),s("p",[t._v("判断当前节点的"),s("code",[t._v("dangerouslySetInnerHTML")]),t._v("属性、孩子节点是否为文本和其他节点分别调用"),s("code",[t._v("DOMLazyTree")]),t._v("的"),s("code",[t._v("queueHTML")]),t._v("、"),s("code",[t._v("queueText")]),t._v("、"),s("code",[t._v("queueChild")]),t._v("。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom10.png",alt:"image"}})]),t._v(" "),s("p",[t._v("可以发现："),s("code",[t._v("DOMLazyTree")]),t._v("实际上是一个包裹对象，"),s("code",[t._v("node")]),t._v("属性中存储了真实的"),s("code",[t._v("DOM")]),t._v("节点，"),s("code",[t._v("children")]),t._v("、"),s("code",[t._v("html")]),t._v("、"),s("code",[t._v("text")]),t._v("分别存储孩子、html 节点和文本节点。")]),t._v(" "),s("p",[t._v("它提供了几个方法用于插入孩子、"),s("code",[t._v("html")]),t._v("以及文本节点，这些插入都是有条件限制的，当"),s("code",[t._v("enableLazy")]),t._v("属性为"),s("code",[t._v("true")]),t._v("时，这些孩子、"),s("code",[t._v("html")]),t._v("以及文本节点会被插入到"),s("code",[t._v("DOMLazyTree")]),t._v("对象中，当其为"),s("code",[t._v("false")]),t._v("时会插入到真实"),s("code",[t._v("DOM")]),t._v("节点中。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" enableLazy "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" document "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"undefined"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("documentMode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"number"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" navigator "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"undefined"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" navigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userAgent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"string"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("\\bEdge\\/\\d")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userAgent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("可见："),s("code",[t._v("enableLazy")]),t._v("是一个变量，当前浏览器是"),s("code",[t._v("IE")]),t._v("或"),s("code",[t._v("Edge")]),t._v("时为"),s("code",[t._v("true")]),t._v("。")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("IE（8-11）")]),t._v("和"),s("code",[t._v("Edge")]),t._v("浏览器中，一个一个插入无子孙的节点，效率要远高于插入一整个序列化完整的节点树。")]),t._v(" "),s("p",[t._v("所以"),s("code",[t._v("lazyTree")]),t._v("主要解决的是在"),s("code",[t._v("IE（8-11）")]),t._v("和"),s("code",[t._v("Edge")]),t._v("浏览器中插入节点的效率问题，在后面的过程 4 我们会分析到：若当前是"),s("code",[t._v("IE")]),t._v("或"),s("code",[t._v("Edge")]),t._v("，则需要递归插入"),s("code",[t._v("DOMLazyTree")]),t._v("中缓存的子节点，其他浏览器只需要插入一次当前节点，因为他们的孩子已经被渲染好了，而不用担心效率问题。")]),t._v(" "),s("p",[t._v("下面来看一下"),s("code",[t._v("ReactCompositeComponent")]),t._v("，由于代码非常多这里就不再贴这个模块的代码，其内部主要做了以下几步：")]),t._v(" "),s("ul",[s("li",[t._v("处理"),s("code",[t._v("props")]),t._v("、"),s("code",[t._v("contex")]),t._v("等变量，调用构造函数创建组件实例")]),t._v(" "),s("li",[t._v("判断是否为无状态组件，处理"),s("code",[t._v("state")])]),t._v(" "),s("li",[t._v("调用"),s("code",[t._v("performInitialMount")]),t._v("生命周期，处理子节点，获取"),s("code",[t._v("markup")]),t._v("。")]),t._v(" "),s("li",[t._v("调用"),s("code",[t._v("componentDidMount")]),t._v("生命周期")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("performInitialMount")]),t._v("函数中，首先调用了"),s("code",[t._v("componentWillMount")]),t._v("生命周期，由于自定义的"),s("code",[t._v("React")]),t._v("组件并不是一个真实的 DOM，所以在函数中又调用了孩子节点的"),s("code",[t._v("mountComponent")]),t._v("。这也是一个递归的过程，当所有孩子节点渲染完成后，返回"),s("code",[t._v("markup")]),t._v("并调用"),s("code",[t._v("componentDidMount")]),t._v("。")]),t._v(" "),s("p",[s("strong",[t._v("过程 4：渲染 html")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("mountComponentIntoNode")]),t._v("函数中调用将上一步生成的"),s("code",[t._v("markup")]),t._v("插入"),s("code",[t._v("container")]),t._v("容器。")]),t._v(" "),s("p",[t._v("在首次渲染时，"),s("code",[t._v("_mountImageIntoNode")]),t._v("会清空"),s("code",[t._v("container")]),t._v("的子节点后调用"),s("code",[t._v("DOMLazyTree.insertTreeBefore")]),t._v("：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom5.png",alt:"image"}})]),t._v(" "),s("p",[t._v("判断是否为"),s("code",[t._v("fragment")]),t._v("节点或者"),s("code",[t._v("<object>")]),t._v("插件：")]),t._v(" "),s("ul",[s("li",[t._v("如果是以上两种，首先调用"),s("code",[t._v("insertTreeChildren")]),t._v("将此节点的孩子节点渲染到当前节点上，再将渲染完的节点插入到"),s("code",[t._v("html")])]),t._v(" "),s("li",[t._v("如果是其他节点，先将节点插入到插入到"),s("code",[t._v("html")]),t._v("，再调用"),s("code",[t._v("insertTreeChildren")]),t._v("将孩子节点插入到"),s("code",[t._v("html")]),t._v("。")]),t._v(" "),s("li",[t._v("若当前不是"),s("code",[t._v("IE")]),t._v("或"),s("code",[t._v("Edge")]),t._v("，则不需要再递归插入子节点，只需要插入一次当前节点。")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/vdom8.png",alt:"image"}})]),t._v(" "),s("ul",[s("li",[t._v("判断不是"),s("code",[t._v("IE")]),t._v("或"),s("code",[t._v("bEdge")]),t._v("时"),s("code",[t._v("return")])]),t._v(" "),s("li",[t._v("若"),s("code",[t._v("children")]),t._v("不为空，递归"),s("code",[t._v("insertTreeBefore")]),t._v("进行插入")]),t._v(" "),s("li",[t._v("渲染 html 节点")]),t._v(" "),s("li",[t._v("渲染文本节点")])]),t._v(" "),s("h3",{attrs:{id:"原生-dom-事件代理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原生-dom-事件代理"}},[t._v("#")]),t._v(" 原生 DOM 事件代理")]),t._v(" "),s("p",[t._v("有关虚拟"),s("code",[t._v("DOM")]),t._v("的事件机制，我曾专门写过一篇文章，有兴趣可以 👇"),s("a",{attrs:{href:"https://juejin.im/post/5c7df2e7f265da2d8a55d49d",target:"_blank",rel:"noopener noreferrer"}},[t._v("【React 深入】React 事件机制"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"虚拟-dom-原理、特性总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom-原理、特性总结"}},[t._v("#")]),t._v(" 虚拟 DOM 原理、特性总结")]),t._v(" "),s("h3",{attrs:{id:"react-组件的渲染流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react-组件的渲染流程"}},[t._v("#")]),t._v(" React 组件的渲染流程")]),t._v(" "),s("ul",[s("li",[t._v("使用"),s("code",[t._v("React.createElement")]),t._v("或"),s("code",[t._v("JSX")]),t._v("编写"),s("code",[t._v("React")]),t._v("组件，实际上所有的"),s("code",[t._v("JSX")]),t._v("代码最后都会转换成"),s("code",[t._v("React.createElement(...)")]),t._v("，"),s("code",[t._v("Babel")]),t._v("帮助我们完成了这个转换的过程。")]),t._v(" "),s("li",[s("code",[t._v("createElement")]),t._v("函数对"),s("code",[t._v("key")]),t._v("和"),s("code",[t._v("ref")]),t._v("等特殊的"),s("code",[t._v("props")]),t._v("进行处理，并获取"),s("code",[t._v("defaultProps")]),t._v("对默认"),s("code",[t._v("props")]),t._v("进行赋值，并且对传入的孩子节点进行处理，最终构造成一个"),s("code",[t._v("ReactElement")]),t._v("对象（所谓的虚拟"),s("code",[t._v("DOM")]),t._v("）。")]),t._v(" "),s("li",[s("code",[t._v("ReactDOM.render")]),t._v("将生成好的虚拟"),s("code",[t._v("DOM")]),t._v("渲染到指定容器上，其中采用了批处理、事务等机制并且对特定浏览器进行了性能优化，最终转换为真实"),s("code",[t._v("DOM")]),t._v("。")])]),t._v(" "),s("h3",{attrs:{id:"虚拟-dom-的组成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom-的组成"}},[t._v("#")]),t._v(" 虚拟 DOM 的组成")]),t._v(" "),s("p",[t._v("即"),s("code",[t._v("ReactElement")]),t._v("element 对象，我们的组件最终会被渲染成下面的结构：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("type")]),t._v("：元素的类型，可以是原生 html 类型（字符串），或者自定义组件（函数或"),s("code",[t._v("class")]),t._v("）")]),t._v(" "),s("li",[s("code",[t._v("key")]),t._v("：组件的唯一标识，用于"),s("code",[t._v("Diff")]),t._v("算法，下面会详细介绍")]),t._v(" "),s("li",[s("code",[t._v("ref")]),t._v("：用于访问原生"),s("code",[t._v("dom")]),t._v("节点")]),t._v(" "),s("li",[s("code",[t._v("props")]),t._v("：传入组件的"),s("code",[t._v("props")]),t._v("，"),s("code",[t._v("chidren")]),t._v("是"),s("code",[t._v("props")]),t._v("中的一个属性，它存储了当前组件的孩子节点，可以是数组（多个孩子节点）或对象（只有一个孩子节点）")]),t._v(" "),s("li",[s("code",[t._v("owner")]),t._v("：当前正在构建的"),s("code",[t._v("Component")]),t._v("所属的"),s("code",[t._v("Component")])]),t._v(" "),s("li",[s("code",[t._v("self")]),t._v("：（非生产环境）指定当前位于哪个组件实例")]),t._v(" "),s("li",[s("code",[t._v("_source")]),t._v("：（非生产环境）指定调试代码来自的文件("),s("code",[t._v("fileName")]),t._v(")和代码行数("),s("code",[t._v("lineNumber")]),t._v(")")])]),t._v(" "),s("h3",{attrs:{id:"防止-xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防止-xss"}},[t._v("#")]),t._v(" 防止 XSS")]),t._v(" "),s("p",[s("code",[t._v("ReactElement")]),t._v("对象还有一个"),s("code",[t._v("$$typeof")]),t._v("属性，它是一个"),s("code",[t._v("Symbol")]),t._v("类型的变量"),s("code",[t._v("Symbol.for('react.element')")]),t._v("，当环境不支持"),s("code",[t._v("Symbol")]),t._v("时，"),s("code",[t._v("$$typeof")]),t._v("被赋值为"),s("code",[t._v("0xeac7")]),t._v("。")]),t._v(" "),s("p",[t._v("这个变量可以防止"),s("code",[t._v("XSS")]),t._v("。如果你的服务器有一个漏洞，允许用户存储任意"),s("code",[t._v("JSON")]),t._v("对象， 而客户端代码需要一个字符串，这可能为你的应用程序带来风险。"),s("code",[t._v("JSON")]),t._v("中不能存储"),s("code",[t._v("Symbol")]),t._v("类型的变量，而"),s("code",[t._v("React")]),t._v("渲染时会把没有"),s("code",[t._v("$$typeof")]),t._v("标识的组件过滤掉。")]),t._v(" "),s("h3",{attrs:{id:"批处理和事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#批处理和事务"}},[t._v("#")]),t._v(" 批处理和事务")]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("在渲染虚拟"),s("code",[t._v("DOM")]),t._v("时应用了批处理以及事务机制，以提高渲染性能。")]),t._v(" "),s("p",[t._v("关于批处理以及事务机制，在我之前的文章"),s("a",{attrs:{href:"https://juejin.im/post/5c71050ef265da2db27938b5",target:"_blank",rel:"noopener noreferrer"}},[t._v("【React 深入】setState 的执行机制"),s("OutboundLink")],1),t._v("中有详细介绍。")]),t._v(" "),s("h3",{attrs:{id:"针对性的性能优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#针对性的性能优化"}},[t._v("#")]),t._v(" 针对性的性能优化")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("IE（8-11）")]),t._v("和"),s("code",[t._v("Edge")]),t._v("浏览器中，一个一个插入无子孙的节点，效率要远高于插入一整个序列化完整的节点树。")]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("通过"),s("code",[t._v("lazyTree")]),t._v("，在"),s("code",[t._v("IE（8-11）")]),t._v("和"),s("code",[t._v("Edge")]),t._v("中进行单个节点依次渲染节点，而在其他浏览器中则首先将整个大的"),s("code",[t._v("DOM")]),t._v("结构构建好，然后再整体插入容器。")]),t._v(" "),s("p",[t._v("并且，在单独渲染节点时，"),s("code",[t._v("React")]),t._v("还考虑了"),s("code",[t._v("fragment")]),t._v("等特殊节点，这些节点则不会一个一个插入渲染。")]),t._v(" "),s("h3",{attrs:{id:"虚拟-dom-事件机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom-事件机制"}},[t._v("#")]),t._v(" 虚拟 DOM 事件机制")]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("自己实现了一套事件机制，其将所有绑定在虚拟"),s("code",[t._v("DOM")]),t._v("上的事件映射到真正的"),s("code",[t._v("DOM")]),t._v("事件，并将所有的事件都代理到"),s("code",[t._v("document")]),t._v("上，自己模拟了事件冒泡和捕获的过程，并且进行统一的事件分发。")]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("自己构造了合成事件对象"),s("code",[t._v("SyntheticEvent")]),t._v("，这是一个跨浏览器原生事件包装器。 它具有与浏览器原生事件相同的接口，包括"),s("code",[t._v("stopPropagation()")]),t._v("和"),s("code",[t._v("preventDefault()")]),t._v("等等，在所有浏览器中他们工作方式都相同。这抹平了各个浏览器的事件兼容性问题。")]),t._v(" "),s("p",[t._v("上面只分析虚拟"),s("code",[t._v("DOM")]),t._v("首次渲染的原理和过程，当然这并不包括虚拟 "),s("code",[t._v("DOM")]),t._v("进行 "),s("code",[t._v("Diff")]),t._v("的过程，下一篇文章我们再来详细探讨。")]),t._v(" "),s("p",[t._v("关于开篇提的几个问题，我们在下篇文章中进行统一回答。")])])}),[],!1,null,null,null);a.default=n.exports}}]);